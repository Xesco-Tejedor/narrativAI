<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ narrativAI - Generador de √âpicas con IA REAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }
        .genre-card:hover:not(.selected) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
    </style>
</head>
<body class="text-white">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-purple-600/20 via-pink-600/20 to-yellow-600/20 py-8 mb-8">
        <div class="container mx-auto px-4 max-w-6xl">
            <div class="text-center">
                <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-yellow-500 bg-clip-text text-transparent mb-4">
                    üé≠ narrativAI
                </h1>
                <p class="text-xl md:text-2xl text-gray-300 mb-2">
                    Motor de Narrativas √âpicas + Generaci√≥n de Im√°genes IA REAL
                </p>
                <p class="text-lg text-purple-300 mb-6">
                    ‚ú® APIs reales de Pollinations AI + OpenRouter + Arte estilizado
                </p>
            </div>
        </div>
    </div>
    
    <!-- Nueva secci√≥n de configuraci√≥n de API -->
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">‚öôÔ∏è</div>
                    <h2 class="text-2xl font-bold text-blue-400">Configuraci√≥n de API</h2>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-blue-300 mb-2 flex items-center">
                        üîë OpenRouter API Key (opcional)
                    </label>
                    <div class="relative">
                        <input type="password" id="openrouterApiKey" 
                               placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                               class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30 text-white transition-all pr-10">
                        <button id="toggleApiKeyVisibility" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-400"
                                title="Mostrar/ocultar clave API">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">
                        Ingresa tu clave API gratuita de <a href="https://openrouter.ai/" target="_blank" class="text-blue-400 hover:underline">openrouter.ai</a> para usar modelos adicionales.
                        <br>Se almacena localmente en tu navegador (no se env√≠a a ning√∫n servidor).
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300 mb-2">
                        üß™ Proveedor de Im√°genes Activo
                    </label>
                    <select id="imageProvider" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500">
                        <option value="pollinations">Pollinations AI (predeterminado)</option>
                        <option value="openrouter">OpenRouter AI (requiere clave)</option>
                    </select>
                    <div id="openrouterStatus" class="mt-2 text-xs p-2 rounded bg-gray-700/50">
                        <span class="text-yellow-400">‚ö†Ô∏è</span> OpenRouter no configurado - Ingresa tu clave API arriba
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 max-w-6xl space-y-8">
        <!-- Paso 1: Elementos Clave -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">1</div>
                <div>
                    <h2 class="text-2xl font-bold text-purple-400">Define Tus Elementos Clave</h2>
                    <p class="text-gray-300">Introduce hasta tres elementos para tu narrativa √©pica</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">
                        üéØ Personaje o Elemento Central
                    </label>
                    <input type="text" id="element1" placeholder="ej: un valiente caballero, el √∫ltimo drag√≥n..." 
                           class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">
                        üî∏ Entorno o Elemento de Apoyo
                    </label>
                    <input type="text" id="element2" placeholder="ej: una biblioteca perdida, un sabio ermita√±o..." 
                           class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">
                        üèõÔ∏è Atm√≥sfera o Concepto
                    </label>
                    <input type="text" id="element3" placeholder="ej: un futuro dist√≥pico, un ritual olvidado..." 
                           class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all">
                </div>
            </div>
        </div>
        <!-- Paso 2: G√©neros -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-yellow-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">2</div>
                <div>
                    <h2 class="text-2xl font-bold text-pink-400">Equilibra los G√©neros</h2>
                    <p class="text-gray-300">Selecciona hasta 3 g√©neros y ajusta su intensidad</p>
                </div>
            </div>
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-purple-400">
                    üé≠ Selecciona g√©neros (m√°ximo 3)
                </h3>
                <span id="genreCount" class="text-sm bg-gradient-to-r from-purple-600 to-pink-600 px-3 py-1 rounded-full font-medium">0/3</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="genreGrid">
                <!-- G√©neros se generan din√°micamente -->
            </div>
            <!-- Controles de intensidad -->
            <div id="genreIntensityControls" class="hidden">
                <div class="bg-gray-900/50 rounded-xl p-6 border border-purple-500/30">
                    <h4 class="text-lg font-medium text-purple-300 mb-4 flex items-center">
                        ‚öñÔ∏è Control de Intensidad
                        <div class="ml-4 text-sm bg-green-600 px-2 py-1 rounded-full" id="totalDisplay">100%</div>
                    </h4>
                    <div id="genreSliders" class="space-y-4">
                        <!-- Sliders se generan din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Paso 3: Generar -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- 3.1 Narrativa -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-sm font-bold mr-3">3.1</div>
                        <div>
                            <h3 class="text-xl font-bold text-yellow-400">Genera Narrativa</h3>
                            <p class="text-gray-300 text-sm">Tu historia √©pica estructurada</p>
                        </div>
                    </div>
                    <button id="generateBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="generateBtnText">üé≠ Generar Narrativa</span>
                    </button>
                </div>
                <div id="narrativePlaceholder" class="text-center text-gray-400 py-12 border-2 border-dashed border-gray-600 rounded-lg">
                    <div class="text-4xl mb-3">üìö</div>
                    <p class="text-lg">¬°Completa los elementos y g√©neros para comenzar!</p>
                </div>
                <div id="narrativeContent" class="hidden">
                    <div class="bg-gray-900/50 rounded-lg p-6 border border-purple-500/30">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm text-purple-300 font-medium">üìù Tu Narrativa √âpica</span>
                            <div class="flex gap-2">
                                <button id="editNarrativeBtn" onclick="toggleNarrativeEdit()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button id="saveNarrativeBtn" onclick="saveNarrativeEdit()" class="hidden px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors">
                                    üíæ Guardar
                                </button>
                                <button id="cancelNarrativeBtn" onclick="cancelNarrativeEdit()" class="hidden px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition-colors">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                        <!-- Vista de lectura -->
                        <div id="narrativeDisplay" class="text-gray-100 leading-relaxed text-lg"></div>
                        <!-- Editor de texto -->
                        <div id="narrativeEditor" class="hidden">
                            <textarea id="narrativeTextarea" 
                                      class="w-full h-64 p-4 bg-gray-800 border border-gray-600 rounded-lg text-gray-100 leading-relaxed text-lg resize-none focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30"
                                      placeholder="Edita tu narrativa √©pica aqu√≠..."></textarea>
                            <div class="mt-2 text-xs text-gray-400 flex justify-between">
                                <span>üí° Tip: Los cambios se aplicar√°n autom√°ticamente al generar nuevas im√°genes</span>
                                <span id="charCount">0 caracteres</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                        <p class="text-sm text-green-300">
                            ‚úÖ <strong>Narrativa estructurada:</strong> Establecimiento ‚Üí Desarrollo ‚Üí Cl√≠max ‚Üí Resoluci√≥n
                        </p>
                    </div>
                </div>
                <div id="loadingNarrative" class="hidden text-center py-8">
                    <div class="loading-animation text-4xl mb-3">üé≠</div>
                    <p class="text-purple-300 text-lg">Tejiendo tu narrativa √©pica...</p>
                </div>
            </div>
            <!-- 3.2 Im√°genes IA REAL -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-sm font-bold mr-3">3.2</div>
                        <div>
                            <h3 class="text-xl font-bold text-purple-400">Generaci√≥n IA REAL</h3>
                            <p class="text-gray-300 text-sm">APIs reales + Arte estilizado robusto</p>
                        </div>
                    </div>
                    <button id="generateImageBtn" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="generateImageBtnText">üé® Generar Imagen IA</span>
                    </button>
                </div>
                <!-- Selector de Estilo Art√≠stico CORREGIDO -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-purple-300 mb-3">
                        üé® Estilo Art√≠stico
                    </label>
                    <select id="artStyle" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500">
                        <option value="auto">ü§ñ Autom√°tico (adapta el estilo a tu narrativa)</option>
                        <option value="lorenzale-allegory-style">üèõÔ∏è Claudi Lorenzale - Alegor√≠a rom√°ntico-nazarena</option>
                        <option value="rackham-style">üßö Arthur Rackham - Pen & ink con acuarelas delicadas</option>
                        <option value="wrightson-style">üíÄ Bernie Wrightson - Tinta maestra con claroscuro dram√°tico</option>
                        <option value="moebius-style">üåå Moebius - L√≠neas limpias sci-fi, paisajes et√©reos</option>
                        <option value="frazetta-style">‚öîÔ∏è Frank Frazetta - Pinceladas poderosas, anatom√≠a heroica</option>
                        <option value="brom-style">üåô Gerald Brom - Fantas√≠a oscura digital, g√≥tico contempor√°neo</option>
                        <option value="giger-style">üëæ H.R. Giger - Biomec√°nico alien√≠gena, aer√≥grafo monocrom√°tico</option>
                        <option value="photorealistic">üì∏ Fotorrealista - Calidad fotogr√°fica profesional</option>
                        <option value="digital-art">üñ•Ô∏è Arte Digital - Ilustraci√≥n moderna vectorial</option>
                        <option value="oil-painting">üé® Pintura al √ìleo - T√©cnica tradicional, pinceladas visibles</option>
                        <option value="anime">üáØüáµ Anime/Manga - Ojos expresivos, coloreado cel-shaded</option>
                        <option value="comic-book">üìö C√≥mic - Contornos audaces, colores primarios</option>
                        <option value="fantasy-art">üßô‚Äç‚ôÇÔ∏è Arte Fant√°stico - Realismo m√°gico, criaturas mitol√≥gicas</option>
                    </select>
                </div>
                <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                    <div class="text-3xl mb-2">üé®</div>
                    <div id="placeholderMessage">
                        <p class="text-sm">Genera una narrativa primero, luego crea tu imagen √©pica</p>
                    </div>
                    <div id="readyMessage" class="hidden">
                        <p class="text-sm text-green-300">‚úÖ ¬°Narrativa lista! Ahora puedes generar imagen</p>
                    </div>
                </div>
                <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                    <div class="loading-animation text-3xl mb-2">üöÄ</div>
                    <p class="text-purple-300 text-sm">Generando imagen √©pica con IA REAL...</p>
                    <div class="mt-4 w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full animate-pulse" style="width: 80%"></div>
                    </div>
                </div>
                <!-- Galer√≠a de im√°genes -->
                <div id="imageGallery" class="hidden space-y-4">
                    <!-- Las im√°genes se a√±adir√°n aqu√≠ din√°micamente -->
                </div>
                <div id="imageStatus" class="mt-3 p-3 bg-green-900/30 rounded-lg border border-green-500/50 text-sm text-green-300 hidden">
                    <!-- Status se actualiza din√°micamente -->
                </div>
                <!-- Controles de imagen -->
                <div id="imageControls" class="hidden mt-4 flex flex-wrap gap-2">
                    <button onclick="regenerateImage()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition-colors">
                        üîÑ Nueva Variaci√≥n
                    </button>
                    <button onclick="clearImageHistory()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">
                        üóëÔ∏è Limpiar Galer√≠a
                    </button>
                </div>
            </div>
        </div>
        <!-- Paso 4: Exportar -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">4</div>
                    <div>
                        <h2 class="text-2xl font-bold text-green-400">Exporta Tu Proyecto</h2>
                        <p class="text-gray-300">Descarga todo en un ZIP completo</p>
                    </div>
                </div>
                <button onclick="downloadProject()" id="downloadBtn" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50">
                    üì¶ Descargar ZIP
                </button>
            </div>
            <div id="exportStatus" class="text-center text-gray-400 py-8">
                <div class="text-4xl mb-3">üì¶</div>
                <p class="text-lg">Genera tu narrativa para activar la exportaci√≥n</p>
            </div>
        </div>
    </div>
    <script>
        // ==================== ESTADO DE LA APLICACI√ìN - ACTUALIZADO ====================
        let appState = {
            selectedGenres: [],
            genreIntensities: {},
            generatedNarrative: '',
            imageHistory: [],
            isGenerating: false,
            currentGeneration: 0, // CONTADOR PARA DEBUGGING
            openrouterApiKey: localStorage.getItem('openrouterApiKey') || '', // Carga desde localStorage
            activeImageProvider: localStorage.getItem('activeImageProvider') || 'pollinations'
        };
        
        // ==================== G√âNEROS DISPONIBLES ====================
        const genres = {
            'terror': { name: 'Terror', icon: 'üëª', color: 'from-red-600 to-red-800' },
            'fantasia': { name: 'Fantas√≠a', icon: 'üßô‚Äç‚ôÇÔ∏è', color: 'from-purple-600 to-purple-800' },
            'romance': { name: 'Romance', icon: 'üíï', color: 'from-pink-600 to-pink-800' },
            'misterio': { name: 'Misterio', icon: 'üîç', color: 'from-yellow-600 to-yellow-800' },
            'ciencia-ficcion': { name: 'Ciencia Ficci√≥n', icon: 'üöÄ', color: 'from-blue-600 to-blue-800' },
            'aventura': { name: 'Aventura', icon: '‚öîÔ∏è', color: 'from-green-600 to-green-800' },
            'comedia': { name: 'Comedia', icon: 'üòÑ', color: 'from-orange-600 to-orange-800' },
            'drama': { name: 'Drama', icon: 'üé≠', color: 'from-indigo-600 to-indigo-800' }
        };
        
        // ==================== ESTILOS ART√çSTICOS CORREGIDOS ====================
        const artisticStyles = {
            'auto': {
                name: 'Autom√°tico',
                prompt: 'epic fantasy art, masterpiece quality, professional illustration, cinematic lighting',
                keywords: ['epic', 'fantasy', 'professional', 'cinematic']
            },
            'lorenzale-allegory-style': {
                name: 'Claudi Lorenzale i Sugra√±es',
                prompt: 'masterpiece in the style of Claudi Lorenzale i Sugra√±es, 19th century Romantic-Nazarene Catalan painter, precise academic drawing with clear contours, idealized female figures with classical beauty, serene melancholic expressions, flowing classical drapery, warm golden and earth tone palette, balanced neoclassical composition, allegory of moral virtues, soft diffused lighting, meticulous anatomical detail, Barcelona romantic school painting',
                keywords: ['Lorenzale', 'romantic painting', 'academic drawing', 'allegorical', 'classical', 'Catalan school']
            },
            'rackham-style': {
                name: 'Arthur Rackham',
                prompt: 'Arthur Rackham style illustration, intricate pen and ink linework, delicate watercolor washes, sinuous organic lines, muted earth tones with touches of gold, fairy tale atmosphere, detailed crosshatching, golden age book illustration, mystical folklore',
                keywords: ['pen and ink', 'watercolor', 'fairy tale', 'crosshatching', 'organic lines']
            },
            'wrightson-style': {
                name: 'Bernie Wrightson',
                prompt: 'Bernie Wrightson style horror illustration, masterful ink work with deep blacks, dramatic chiaroscuro lighting, intricate crosshatching and stippling, gothic horror atmosphere, detailed linework, dramatic shadows and highlights, macabre and atmospheric',
                keywords: ['horror', 'ink work', 'crosshatching', 'chiaroscuro', 'gothic']
            },
            'moebius-style': {
                name: 'Moebius',
                prompt: 'Moebius Jean Giraud style illustration, clean precise linework, ethereal sci-fi landscapes, surreal dreamlike compositions, soft pastel colors with electric blues, floating geometric structures, European comic book style, detailed mechanical and organic forms',
                keywords: ['moebius', 'sci-fi', 'clean lines', 'surreal', 'geometric']
            },
            'frazetta-style': {
                name: 'Frank Frazetta',
                prompt: 'Frank Frazetta style painting, powerful visible brushwork, heroic fantasy themes, dramatic muscle definition, rich warm color palette, dynamic action poses, oil painting technique with impasto effects, barbarian and sword-and-sorcery aesthetic, raw power and energy',
                keywords: ['frazetta', 'oil painting', 'heroic', 'muscular', 'sword and sorcery']
            },
            'brom-style': {
                name: 'Gerald Brom',
                prompt: 'Gerald Brom style dark fantasy art, rich digital painting technique, gothic and macabre themes, muted desaturated colors with deep browns and reds, detailed character work with emotional intensity, blend of beauty and horror, contemporary dark fantasy aesthetic',
                keywords: ['brom', 'dark fantasy', 'gothic', 'digital painting', 'macabre']
            },
            'giger-style': {
                name: 'H.R. Giger',
                prompt: 'H.R. Giger biomechanical style, nightmarish fusion of organic and mechanical elements, masterful airbrush technique in monochromatic grays, alien imagery, detailed technical precision, surreal horror aesthetic, xenomorph-inspired, dark industrial Gothic',
                keywords: ['biomechanical', 'alien', 'airbrush', 'horror', 'technical']
            },
            'photorealistic': {
                name: 'Fotorrealista',
                prompt: 'photorealistic style, professional photography quality, sharp focus with shallow depth of field, natural lighting, high dynamic range, ultra-detailed textures, cinematic composition, documentary realism, perfect exposure',
                keywords: ['photorealistic', 'professional photography', 'natural lighting', 'sharp focus']
            },
            'digital-art': {
                name: 'Arte Digital',
                prompt: 'modern digital art illustration, clean vector-influenced style, vibrant saturated colors, smooth gradients and lighting effects, contemporary graphic design aesthetic, professional concept art quality, polished and refined technique',
                keywords: ['digital art', 'concept art', 'vector style', 'vibrant colors']
            },
            'oil-painting': {
                name: 'Pintura al √ìleo',
                prompt: 'traditional oil painting technique, visible brushstrokes with impasto texture, rich and vibrant color palette, academic realism style, canvas texture visible, classical European painting tradition, deep color depth and luminosity',
                keywords: ['oil painting', 'classical', 'brushstrokes', 'traditional', 'impasto']
            },
            'anime': {
                name: 'Anime/Manga',
                prompt: 'anime and manga art style, large expressive eyes, stylized colorful hair and clothing, cell-shaded coloring technique, Japanese animation aesthetic, clean linework, bright saturated colors, dramatic expressions and poses',
                keywords: ['anime', 'manga', 'cell-shaded', 'japanese animation', 'expressive']
            },
            'comic-book': {
                name: 'C√≥mic',
                prompt: 'comic book illustration style, bold outlines with flat color fills, dynamic action-oriented composition, primary color palette with high contrast, superhero comic aesthetic, dramatic perspective and foreshortening, sequential visual narrative',
                keywords: ['comic book', 'bold outlines', 'primary colors', 'dynamic action']
            },
            'fantasy-art': {
                name: 'Arte Fant√°stico',
                prompt: 'fantasy art illustration, magical realism style, detailed world-building elements, rich atmospheric lighting, mythological and legendary themes, dragons and magical creatures, elaborate costume and architectural design, epic dramatic compositions',
                keywords: ['fantasy art', 'magical realism', 'mythological', 'elaborate design']
            }
        };
        
        // ==================== SISTEMA DE NOTIFICACIONES ====================
        function showNotification(message, type) {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            try {
                const colors = {
                    'green': 'bg-green-600',
                    'yellow': 'bg-yellow-600', 
                    'red': 'bg-red-600',
                    'blue': 'bg-blue-600',
                    'purple': 'bg-purple-600'
                };
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 ${colors[type] || 'bg-gray-600'} text-white px-4 py-2 rounded-lg z-50 max-w-sm shadow-lg transition-all duration-300`;
                notification.textContent = message;
                if (document.body) {
                    document.body.appendChild(notification);
                    setTimeout(() => {
                        try {
                            if (notification && notification.parentNode) {
                                document.body.removeChild(notification);
                            }
                        } catch (removeError) {
                            console.warn('Error removiendo notificaci√≥n:', removeError);
                        }
                    }, type === 'red' ? 6000 : 3000);
                }
            } catch (error) {
                console.error('Error creando notificaci√≥n:', error);
            }
        }
        
        // ==================== FUNCIONES DE CONFIGURACI√ìN DE API ====================
        function setupApiConfiguration() {
            const apiKeyInput = document.getElementById('openrouterApiKey');
            const toggleVisibilityBtn = document.getElementById('toggleApiKeyVisibility');
            const imageProviderSelect = document.getElementById('imageProvider');
            const openrouterStatus = document.getElementById('openrouterStatus');
            
            // Cargar clave API guardada
            if (appState.openrouterApiKey) {
                apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateOpenrouterStatus(true);
            }
            
            // Toggle de visibilidad de la clave API
            toggleVisibilityBtn.addEventListener('click', function() {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    this.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                } else {
                    apiKeyInput.type = 'password';
                    this.textContent = 'üëÅÔ∏è';
                }
            });
            
            // Guardar clave API al cambiar
            apiKeyInput.addEventListener('change', function() {
                const apiKey = this.value.trim();
                if (apiKey) {
                    appState.openrouterApiKey = apiKey;
                    localStorage.setItem('openrouterApiKey', apiKey);
                    this.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    updateOpenrouterStatus(true);
                } else {
                    appState.openrouterApiKey = '';
                    localStorage.removeItem('openrouterApiKey');
                    updateOpenrouterStatus(false);
                }
            });
            
            // Configurar proveedor activo
            imageProviderSelect.value = appState.activeImageProvider;
            imageProviderSelect.addEventListener('change', function() {
                appState.activeImageProvider = this.value;
                localStorage.setItem('activeImageProvider', this.value);
                updateOpenrouterStatus(!!appState.openrouterApiKey);
            });
        }
        
        function updateOpenrouterStatus(hasApiKey) {
            const openrouterStatus = document.getElementById('openrouterStatus');
            const imageProviderSelect = document.getElementById('imageProvider');
            
            if (imageProviderSelect.value === 'openrouter') {
                if (hasApiKey) {
                    openrouterStatus.innerHTML = '<span class="text-green-400">‚úì</span> OpenRouter configurado correctamente';
                } else {
                    openrouterStatus.innerHTML = '<span class="text-yellow-400">‚ö†Ô∏è</span> OpenRouter no configurado - Ingresa tu clave API arriba';
                }
            } else {
                openrouterStatus.innerHTML = '<span class="text-blue-400">‚ÑπÔ∏è</span> Usando Pollinations AI como proveedor predeterminado';
            }
        }
        
        // ==================== GESTI√ìN DE G√âNEROS ====================
        function createGenreElements() {
            const genreGrid = document.getElementById('genreGrid');
            Object.keys(genres).forEach(genreId => {
                const genre = genres[genreId];
                const genreCard = document.createElement('div');
                genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
                genreCard.dataset.genreId = genreId;
                genreCard.innerHTML = `
                    <div class="text-3xl mb-2">${genre.icon}</div>
                    <div class="text-sm font-medium">${genre.name}</div>
                `;
                genreCard.addEventListener('click', () => toggleGenre(genreId));
                genreGrid.appendChild(genreCard);
            });
        }
        
        function toggleGenre(genreId) {
            const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
            const isSelected = appState.selectedGenres.includes(genreId);
            if (isSelected) {
                appState.selectedGenres = appState.selectedGenres.filter(g => g !== genreId);
                genreCard.classList.remove('selected');
                delete appState.genreIntensities[genreId];
            } else {
                if (appState.selectedGenres.length < 3) {
                    appState.selectedGenres.push(genreId);
                    genreCard.classList.add('selected');
                    // Inicializar intensidad con un valor seguro
                    appState.genreIntensities[genreId] = 33;
                } else {
                    showNotification('‚ö†Ô∏è Ya tienes 3 g√©neros. Deselecciona uno primero.', 'yellow');
                    return;
                }
            }
            updateGenreCount();
            updateGenreIntensityControls();
        }
        
        function updateGenreCount() {
            const genreCount = document.getElementById('genreCount');
            genreCount.textContent = `${appState.selectedGenres.length}/3`;
        }
        
        // CORRECCI√ìN DE BARRAS DE INTENSIDAD
        function updateGenreIntensityControls() {
            const controlsSection = document.getElementById('genreIntensityControls');
            const slidersContainer = document.getElementById('genreSliders');
            
            if (appState.selectedGenres.length === 0) {
                controlsSection.classList.add('hidden');
                return;
            }
            
            controlsSection.classList.remove('hidden');
            slidersContainer.innerHTML = '';
            
            // CORRECCI√ìN: Asegurar que la suma total sea 100%
            let totalIntensity = 0;
            const validGenres = [];
            
            // Primero calcular el total y validar los valores existentes
            appState.selectedGenres.forEach(genreId => {
                let intensity = appState.genreIntensities[genreId] || 0;
                
                // Validar que el valor est√© en rango
                if (intensity < 1) intensity = 1;
                if (intensity > 98) intensity = 98;
                
                appState.genreIntensities[genreId] = intensity;
                totalIntensity += intensity;
                validGenres.push(genreId);
            });
            
            // Si no hay g√©neros v√°lidos, inicializar con distribuci√≥n equitativa
            if (validGenres.length === 0) {
                const baseValue = Math.floor(100 / appState.selectedGenres.length);
                let remainder = 100 - (baseValue * appState.selectedGenres.length);
                
                appState.selectedGenres.forEach((genreId, index) => {
                    const value = baseValue + (index < remainder ? 1 : 0);
                    appState.genreIntensities[genreId] = value;
                    totalIntensity += value;
                    validGenres.push(genreId);
                });
            }
            
            // Ajustar si la suma no es 100
            if (totalIntensity !== 100 && validGenres.length > 0) {
                const adjustment = 100 - totalIntensity;
                let genresToUpdate = [...validGenres];
                
                // Distribuir el ajuste proporcionalmente
                while (adjustment !== 0 && genresToUpdate.length > 0) {
                    const genreId = genresToUpdate.shift();
                    const currentValue = appState.genreIntensities[genreId];
                    
                    if (adjustment > 0 && currentValue < 98) {
                        appState.genreIntensities[genreId] = currentValue + 1;
                        adjustment--;
                    } else if (adjustment < 0 && currentValue > 2) {
                        appState.genreIntensities[genreId] = currentValue - 1;
                        adjustment++;
                    }
                }
                
                // Si a√∫n hay ajuste pendiente, redistribuir
                if (adjustment !== 0) {
                    validGenres.forEach(genreId => {
                        const currentValue = appState.genreIntensities[genreId];
                        const newValue = currentValue + Math.round(adjustment / validGenres.length);
                        
                        if (newValue >= 1 && newValue <= 98) {
                            appState.genreIntensities[genreId] = newValue;
                        }
                    });
                }
            }
            
            // Generar los sliders
            validGenres.forEach(genreId => {
                const genre = genres[genreId];
                const intensity = appState.genreIntensities[genreId];
                
                const sliderHtml = `
                    <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${genre.icon}</span>
                                <span class="font-medium text-gray-200">${genre.name}</span>
                            </div>
                            <span id="intensity-value-${genreId}" class="text-sm font-bold text-purple-300 bg-purple-900/30 px-2 py-1 rounded">
                                ${intensity}%
                            </span>
                        </div>
                        <input type="range" 
                               id="intensity-${genreId}" 
                               min="1" 
                               max="98" 
                               value="${intensity}"
                               class="w-full accent-purple-500 h-2 rounded-lg appearance-none bg-gray-700"
                               oninput="updateGenreIntensity('${genreId}', this.value)">
                    </div>
                `;
                slidersContainer.innerHTML += sliderHtml;
            });
            
            updateTotalIndicator();
        }
        
        function updateTotalIndicator() {
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            const totalDisplay = document.getElementById('totalDisplay');
            if (totalDisplay) {
                totalDisplay.textContent = `${total}%`;
                totalDisplay.className = total === 100 ? 
                    'ml-4 text-sm bg-green-600 px-2 py-1 rounded-full' : 
                    'ml-4 text-sm bg-yellow-600 px-2 py-1 rounded-full';
            }
        }
        
        window.updateGenreIntensity = function(genreId, value) {
            const newValue = parseInt(value);
            appState.genreIntensities[genreId] = newValue;
            
            const otherGenres = appState.selectedGenres.filter(id => id !== genreId);
            if (otherGenres.length > 0) {
                let otherTotal = otherGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
                const targetOtherTotal = 100 - newValue;
                
                if (targetOtherTotal > 0 && otherTotal > 0) {
                    const ratio = targetOtherTotal / otherTotal;
                    let adjustment = 0;
                    let adjustedTotal = 0;
                    
                    // Primero ajustar proporcionalmente
                    otherGenres.forEach(id => {
                        const currentValue = appState.genreIntensities[id] || 0;
                        const adjustedValue = Math.max(1, Math.round(currentValue * ratio));
                        appState.genreIntensities[id] = adjustedValue;
                        adjustedTotal += adjustedValue;
                    });
                    
                    // Ajustar cualquier diferencia restante
                    const diff = targetOtherTotal - adjustedTotal;
                    if (diff !== 0 && otherGenres.length > 0) {
                        const index = Math.floor(Math.random() * otherGenres.length);
                        const id = otherGenres[index];
                        const currentValue = appState.genreIntensities[id];
                        
                        if (diff > 0 && currentValue < 98) {
                            appState.genreIntensities[id] = currentValue + diff;
                        } else if (diff < 0 && currentValue > 2) {
                            appState.genreIntensities[id] = currentValue + diff;
                        }
                    }
                }
            }
            
            // Actualizar visualmente
            appState.selectedGenres.forEach(id => {
                const slider = document.getElementById(`intensity-${id}`);
                const valueSpan = document.getElementById(`intensity-value-${id}`);
                if (slider) slider.value = appState.genreIntensities[id] || 33;
                if (valueSpan) valueSpan.textContent = `${appState.genreIntensities[id] || 33}%`;
            });
            
            updateTotalIndicator();
        };
        
        // ==================== GENERACI√ìN DE NARRATIVA ====================
        function generateNarrative() {
            const element1 = document.getElementById('element1').value.trim();
            const element2 = document.getElementById('element2').value.trim();
            const element3 = document.getElementById('element3').value.trim();
            if (!element1 && !element2 && !element3) {
                throw new Error('üéØ Ingresa al menos un elemento para comenzar tu √©pica.');
            }
            if (appState.selectedGenres.length === 0) {
                throw new Error('üé≠ Selecciona al menos un g√©nero para dar forma a tu historia.');
            }
            const elements = [element1, element2, element3].filter(Boolean);
            const genreNames = appState.selectedGenres.map(id => genres[id].name);
            const dominantGenres = appState.selectedGenres
                .map(id => ({
                    id,
                    name: genreNames[appState.selectedGenres.indexOf(id)],
                    intensity: appState.genreIntensities[id] || 70
                }))
                .sort((a, b) => b.intensity - a.intensity);
            let narrativeStyle = '';
            if (dominantGenres[0]?.intensity > 85) {
                narrativeStyle = `Con una fuerte influencia de ${dominantGenres[0].name.toLowerCase()}, `;
            } else if (dominantGenres.length > 1) {
                narrativeStyle = `Balanceando elementos de ${dominantGenres.map(g => g.name.toLowerCase()).join(' y ')}, `;
            }
            const narratives = [
                `${narrativeStyle}en las profundidades de ${element2 || 'un lugar misterioso'}, donde ${element3 || 'objetos antiguos'} guardan secretos milenarios, ${element1 || 'nuestro protagonista'} descubre que su destino est√° entrelazado con fuerzas m√°s all√° de su comprensi√≥n.`,
                `${narrativeStyle}cuando ${element1 || 'el protagonista'} se encuentra frente a ${element2 || 'lo desconocido'}, la presencia de ${element3 || 'elementos m√≠sticos'} revela verdades que cambiar√°n el curso de esta historia donde ${genreNames.join(' y ').toLowerCase()} se entrelazan.`,
                `Los elementos se entrelazan en una danza c√≥smica: ${elements.join(', ')} se convierten en las piezas fundamentales de una narrativa que ${narrativeStyle}trasciende los g√©neros de ${genreNames.join(', ')}, creando algo completamente nuevo y extraordinario.`,
                `En este universo donde ${genreNames.map(name => name.toLowerCase()).join(' se fusiona con ')} en perfecta armon√≠a, ${narrativeStyle}cada elemento cobra vida propia. ${element1 || 'El protagonista'} debe navegar entre ${element2 || 'm√∫ltiples realidades'} mientras ${element3 || 'fuerzas ancestrales'} despiertan para revelar los secretos m√°s profundos de la existencia.`
            ];
            return narratives.join('
');
        }
        
        // ==================== SISTEMA ROBUSTO DE GENERACI√ìN DE IM√ÅGENES ====================
        // Traducir espa√±ol a ingl√©s de forma simple pero efectiva
        function translateToEnglish(text) {
            if (!text) return text;
            const translations = {
                // Palabras b√°sicas
                'y': 'and', 'o': 'or', 'en': 'in', 'el': 'the', 'la': 'the', 'los': 'the', 'las': 'the',
                'un': 'a', 'una': 'a', 'de': 'of', 'del': 'of the', 'con': 'with',
                // Narrativa
                'historia': 'story', 'narrativa': 'narrative', 'aventura': 'adventure', 'cuento': 'tale',
                'protagonista': 'protagonist', 'personaje': 'character', 'h√©roe': 'hero', 'hero√≠na': 'heroine',
                // Lugares
                'castillo': 'castle', 'biblioteca': 'library', 'bosque': 'forest', 'monta√±a': 'mountain',
                'oc√©ano': 'ocean', 'templo': 'temple', 'cueva': 'cave', 'torre': 'tower',
                // Objetos
                'libro': 'book', 'espada': 'sword', 'cristal': 'crystal', 'drag√≥n': 'dragon',
                'mago': 'wizard', 'hada': 'fairy', 'magia': 'magic',
                // G√©neros
                'terror': 'horror', 'fantasia': 'fantasy', 'romance': 'romance', 'misterio': 'mystery',
                'ciencia ficcion': 'science fiction', 'aventura': 'adventure', 'comedia': 'comedy', 'drama': 'drama',
                // Frases espec√≠ficas
                'pececillo de plata': 'silverfish creature',
                'biblioteca gigantesca': 'gigantic library',
                'fuerzas ancestrales': 'ancestral forces',
                'elementos m√≠sticos': 'mystical elements'
            };
            let translatedText = text.toLowerCase();
            // Procesar frases complejas primero
            Object.keys(translations).forEach(spanish => {
                if (spanish.includes(' ')) {
                    const regex = new RegExp('\\b' + spanish.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    translatedText = translatedText.replace(regex, translations[spanish]);
                }
            });
            // Luego procesar palabras individuales
            Object.keys(translations).forEach(spanish => {
                if (!spanish.includes(' ')) {
                    const regex = new RegExp('\\b' + spanish.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    translatedText = translatedText.replace(regex, translations[spanish]);
                }
            });
            return translatedText.replace(/\s+/g, ' ').trim();
        }
        
        // Crear prompt optimizado para IA con estilo art√≠stico
        function createImagePrompt(narrative, customElements) {
            // Obtener estilo art√≠stico seleccionado
            const artStyleSelect = document.getElementById('artStyle');
            const selectedStyle = artStyleSelect ? artStyleSelect.value : 'auto';
            const styleData = artisticStyles[selectedStyle] || artisticStyles['auto'];
            console.log(`üé® APLICANDO ESTILO: "${styleData.name}"`);
            console.log(`üìù Prompt del estilo: ${styleData.prompt.substring(0, 100)}...`);
            // Comenzar con el prompt del estilo (m√°xima prioridad)
            let promptParts = [styleData.prompt];
            // Traducir narrativa al ingl√©s
            const englishNarrative = translateToEnglish(narrative);
            // A√±adir elementos personalizados traducidos
            if (customElements.length > 0) {
                customElements.forEach((element, index) => {
                    const translatedElement = translateToEnglish(element);
                    if (index === 0) {
                        promptParts.push(`featuring ${translatedElement} as main subject`);
                    } else {
                        promptParts.push(`with ${translatedElement}`);
                    }
                });
            }
            // Analizar narrativa para mood
            let baseMood = 'epic scene';
            const lowerText = englishNarrative.toLowerCase();
            if (lowerText.includes('dark') || lowerText.includes('shadow')) baseMood = 'dark mysterious scene';
            else if (lowerText.includes('magic') || lowerText.includes('mystical')) baseMood = 'magical enchanting scene';
            else if (lowerText.includes('romantic') || lowerText.includes('love')) baseMood = 'romantic warm scene';
            else if (lowerText.includes('horror') || lowerText.includes('terror')) baseMood = 'horror terrifying scene';
            else if (lowerText.includes('adventure') || lowerText.includes('heroic')) baseMood = 'adventurous heroic scene';
            promptParts.push(baseMood);
            // A√±adir keywords del estilo
            promptParts.push(styleData.keywords.slice(0, 3).join(', '));
            // Calidad profesional
            promptParts.push('professional artwork, masterpiece quality');
            const finalPrompt = promptParts.join(', ');
            console.log(`üé® PROMPT FINAL CON ESTILO "${styleData.name}":`, finalPrompt);
            return finalPrompt;
        }
        
        // Generar con OpenRouter
        async function generateWithOpenRouter(prompt, width, height, seed, styleData) {
            console.log(`üîÑ Intentando generaci√≥n con OpenRouter...`);
            
            // Mapeo de estilos a modelos de OpenRouter
            const modelMapping = {
                'auto': 'stability-ai/sdxl',
                'photorealistic': 'stability-ai/sdxl',
                'digital-art': 'black-forest-labs/flux-pro',
                'oil-painting': 'stability-ai/sdxl',
                'anime': 'black-forest-labs/flux-pro',
                'comic-book': 'black-forest-labs/flux-pro',
                'fantasy-art': 'stability-ai/sdxl',
                'lorenzale-allegory-style': 'stability-ai/sdxl',
                'rackham-style': 'black-forest-labs/flux-pro',
                'wrightson-style': 'stability-ai/sdxl',
                'moebius-style': 'black-forest-labs/flux-pro',
                'frazetta-style': 'stability-ai/sdxl',
                'brom-style': 'stability-ai/sdxl',
                'giger-style': 'stability-ai/sdxl'
            };
            
            const model = modelMapping[styleData.name] || 'stability-ai/sdxl';
            const startTime = Date.now();
            
            try {
                const response = await fetch('https://openrouter.ai/api/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.openrouterApiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'narrativAI'
                    },
                    body: JSON.stringify({
                        model: model,
                        prompt: prompt,
                        n: 1,
                        size: `${width}x${height}`,
                        response_format: 'url'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`OpenRouter error ${response.status}: ${errorData.error?.message || 'Error desconocido'}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Respuesta de OpenRouter:', data);
                
                if (data.data && data.data[0] && data.data[0].url) {
                    return {
                        url: data.data[0].url,
                        prompt: prompt,
                        originalPrompt: prompt,
                        appliedStyle: styleData.name,
                        styleKeywords: styleData.keywords,
                        width: width,
                        height: height,
                        seed: seed,
                        api: `OpenRouter (${model})`,
                        isRealAI: true,
                        isGenerated: true,
                        isPlaceholder: false,
                        loadTime: Date.now() - startTime,
                        generation: appState.currentGeneration
                    };
                } else {
                    throw new Error('Respuesta inesperada de OpenRouter');
                }
            } catch (error) {
                console.error('‚ùå Error con OpenRouter:', error);
                throw error;
            }
        }
        
        // Generar con Pollinations
        async function generateWithPollinations(prompt, width, height, seed, styleData) {
            const startTime = Date.now();
            // APIS M√öLTIPLES CON CONFIGURACI√ìN ROBUSTA
            const imageAPIs = [
                {
                    name: 'Pollinations AI Flux Ultra',
                    url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&model=flux&enhance=true&quality=high`,
                    timeout: 35000
                },
                {
                    name: 'Pollinations AI Standard Plus',
                    url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&enhance=true`,
                    timeout: 30000
                },
                {
                    name: 'Pollinations AI Basic',
                    url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt.substring(0, 300))}?seed=${seed}&nologo=true`,
                    timeout: 25000
                },
                {
                    name: 'Pollinations AI Simple',
                    url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt.substring(0, 200))}?seed=${seed}`,
                    timeout: 20000
                },
                {
                    name: 'Pollinations AI Minimal',
                    url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt.substring(0, 100))}`,
                    timeout: 15000
                }
            ];
            
            // PROBAR CADA API CON LOGGING DETALLADO
            for (let i = 0; i < imageAPIs.length; i++) {
                const api = imageAPIs[i];
                console.log(`üîÑ [Generaci√≥n #${appState.currentGeneration}] Probando API ${i+1}/${imageAPIs.length}: ${api.name}`);
                try {
                    const result = await tryImageGeneration(api, prompt);
                    if (result && result.isValid) {
                        console.log(`üéâ [Generaci√≥n #${appState.currentGeneration}] ¬°√âXITO CON ${api.name}!`);
                        return {
                            url: result.url,
                            prompt: prompt,
                            originalPrompt: prompt,
                            appliedStyle: styleData.name,
                            styleKeywords: styleData.keywords,
                            width: result.width || width,
                            height: result.height || height,
                            seed: seed,
                            api: api.name,
                            isRealAI: true,
                            isGenerated: true,
                            isPlaceholder: false,
                            loadTime: result.loadTime,
                            generation: appState.currentGeneration
                        };
                    }
                } catch (error) {
                    console.warn(`‚ùå [Generaci√≥n #${appState.currentGeneration}] ${api.name} fall√≥:`, error.message);
                    // Continuar con la siguiente API
                }
            }
            
            // Si llegamos aqu√≠, todas las APIs de Pollinations fallaron
            throw new Error('Todas las APIs de Pollinations fallaron');
        }
        
        // Intentar generaci√≥n directa de imagen con API real
        async function tryImageGeneration(apiConfig, prompt) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const timeout = apiConfig.timeout || 30000; // 30 segundos timeout generoso
                console.log(`üöÄ Intentando ${apiConfig.name} con timeout de ${timeout}ms`);
                console.log(`üîó URL: ${apiConfig.url}`);
                const timeoutId = setTimeout(() => {
                    console.warn(`‚è∞ Timeout alcanzado en ${apiConfig.name} despu√©s de ${timeout}ms`);
                    reject(new Error(`Timeout despu√©s de ${timeout}ms`));
                }, timeout);
                const img = new Image();
                img.onload = function() {
                    clearTimeout(timeoutId);
                    const loadTime = Date.now() - startTime;
                    const width = this.naturalWidth || this.width;
                    const height = this.naturalHeight || this.height;
                    console.log(`‚úÖ ¬°IMAGEN REAL CARGADA EN ${apiConfig.name}!`);
                    console.log(`üìê Dimensiones: ${width}x${height}`);
                    console.log(`‚è±Ô∏è Tiempo: ${loadTime}ms`);
                    if (width > 50 && height > 50) {
                        resolve({
                            url: apiConfig.url,
                            width: width,
                            height: height,
                            loadTime: loadTime,
                            isValid: true,
                            isRealAI: true,
                            apiName: apiConfig.name
                        });
                    } else {
                        reject(new Error(`Imagen muy peque√±a: ${width}x${height}`));
                    }
                };
                img.onerror = function(error) {
                    clearTimeout(timeoutId);
                    console.warn(`‚ùå Error en ${apiConfig.name}:`, error);
                    reject(new Error(`Error de carga: ${error.type || 'desconocido'}`));
                };
                try {
                    img.src = apiConfig.url;
                } catch (srcError) {
                    clearTimeout(timeoutId);
                    reject(new Error(`Error configurando imagen: ${srcError.message}`));
                }
            });
        }
        
        // FUNCI√ìN PRINCIPAL DE GENERACI√ìN - ACTUALIZADA CON OPENROUTER
        async function generateImageWithStyle(prompt) {
            const width = 1024;
            const height = 768;
            const seed = Math.floor(Math.random() * 1000000);
            
            // Incrementar contador de generaci√≥n
            appState.currentGeneration++;
            console.log(`üé® === GENERACI√ìN #${appState.currentGeneration} INICIADA ===`);
            
            // Obtener estilo seleccionado
            const artStyleSelect = document.getElementById('artStyle');
            const selectedStyle = artStyleSelect ? artStyleSelect.value : 'auto';
            const styleData = artisticStyles[selectedStyle] || artisticStyles['auto'];
            console.log(`üé≠ ESTILO SELECCIONADO: "${styleData.name}"`);
            
            // Limpiar prompt para APIs
            const cleanPrompt = prompt
                .replace(/[^\w\s,.!?-]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .substring(0, 500);
            console.log(`üìù PROMPT LIMPIO (${cleanPrompt.length} chars):`, cleanPrompt);
            
            // Decidir qu√© proveedor usar
            let imageResult;
            
            if (appState.activeImageProvider === 'openrouter' && appState.openrouterApiKey) {
                console.log('üöÄ Usando OpenRouter AI como proveedor principal');
                try {
                    imageResult = await generateWithOpenRouter(cleanPrompt, width, height, seed, styleData);
                } catch (error) {
                    console.warn('‚ö†Ô∏è OpenRouter fall√≥, volviendo a Pollinations:', error);
                    showNotification('‚ö†Ô∏è OpenRouter fall√≥, usando Pollinations como fallback', 'yellow');
                    imageResult = await generateWithPollinations(cleanPrompt, width, height, seed, styleData);
                }
            } else {
                console.log('üöÄ Usando Pollinations AI como proveedor principal');
                imageResult = await generateWithPollinations(cleanPrompt, width, height, seed, styleData);
            }
            
            return imageResult;
        }
        
        // Crear arte estilizado personalizado
        async function createStyledArt(prompt, width, height, seed, styleData) {
            console.log(`üé® Creando arte estilizado con estilo: ${styleData.name}`);
            // Paletas espec√≠ficas por estilo
            const stylePalettes = {
                'lorenzale-allegory-style': ['#D4AF37', '#CD853F', '#F5DEB3', '#FFF8DC'], // Dorados acad√©micos
                'rackham-style': ['#8B4513', '#D2691E', '#F4A460', '#DDD6C1'], // Tierra y oro
                'wrightson-style': ['#1C1C1C', '#4A4A4A', '#696969', '#A9A9A9'], // Grises dram√°ticos
                'moebius-style': ['#4169E1', '#87CEEB', '#F0E68C', '#E6E6FA'], // Azules et√©reos
                'frazetta-style': ['#CD853F', '#A0522D', '#D2691E', '#F4A460'], // C√°lidos heroicos
                'brom-style': ['#2F1B14', '#4A0E0E', '#6B1C1C', '#8B4513'], // Oscuros g√≥ticos
                'giger-style': ['#2C2C2C', '#4A4A4A', '#696969', '#808080'], // Met√°licos biomec√°nicos
                'auto': ['#8b5cf6', '#ec4899', '#06b6d4', '#10b981'] // √âpico moderno
            };
            const iconMap = {
                'lorenzale-allegory-style': 'üë∏',
                'rackham-style': 'üßö',
                'wrightson-style': 'üíÄ',
                'moebius-style': 'üåå',
                'frazetta-style': '‚öîÔ∏è',
                'brom-style': 'üåô',
                'giger-style': 'üëæ',
                'auto': '‚ú®'
            };
            const colorPalette = stylePalettes[styleData.name] || stylePalettes['auto'];
            const mainIcon = iconMap[styleData.name] || iconMap['auto'];
            const cleanPrompt = prompt.replace(/[<>&"']/g, '').substring(0, 40);
            const cleanStyleName = styleData.name.replace(/[<>&"']/g, '');
            const cleanKeywords = styleData.keywords.slice(0, 3).join(', ').replace(/[<>&"']/g, '');
            const svgContent = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="artGrad${seed}" cx="50%" cy="50%" r="70%">
                        <stop offset="0%" style="stop-color:${colorPalette[0]};stop-opacity:0.9" />
                        <stop offset="40%" style="stop-color:${colorPalette[1]};stop-opacity:0.7" />
                        <stop offset="70%" style="stop-color:${colorPalette[2]};stop-opacity:0.5" />
                        <stop offset="100%" style="stop-color:${colorPalette[3]};stop-opacity:0.8" />
                    </radialGradient>
                    <filter id="glow${seed}">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <rect width="100%" height="100%" fill="url(#artGrad${seed})"/>
                <text x="50%" y="35%" text-anchor="middle" fill="white" font-size="80" font-family="Arial" filter="url(#glow${seed})">${mainIcon}</text>
                <text x="50%" y="50%" text-anchor="middle" fill="white" font-size="24" font-family="Arial, sans-serif" font-weight="bold">${cleanStyleName}</text>
                <text x="50%" y="58%" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="16" font-family="Arial, sans-serif">Arte Estilizado - narrativAI</text>
                <text x="50%" y="66%" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="12" font-family="Arial, sans-serif" font-style="italic">${cleanKeywords}</text>
                <text x="50%" y="78%" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="11" font-family="Arial, sans-serif">${cleanPrompt}${cleanPrompt.length >= 40 ? '...' : ''}</text>
                <text x="50%" y="88%" text-anchor="middle" fill="rgba(255,255,255,0.5)" font-size="10" font-family="Arial, sans-serif">Seed: ${seed} | ${width}x${height}</text>
                <rect x="3" y="3" width="${width-6}" height="${height-6}" fill="none" stroke="${colorPalette[1]}" stroke-width="2" rx="8" opacity="0.6"/>
            </svg>`;
            try {
                const encodedSvg = btoa(unescape(encodeURIComponent(svgContent)));
                return {
                    url: `image/svg+xml;base64,${encodedSvg}`,
                    prompt: prompt,
                    originalPrompt: prompt,
                    appliedStyle: styleData.name,
                    styleKeywords: styleData.keywords,
                    width: width,
                    height: height,
                    seed: seed,
                    api: `Arte Estilizado ${styleData.name}`,
                    isRealAI: false,
                    isGenerated: true,
                    isPlaceholder: false,
                    isStyled: true,
                    loadTime: 500
                };
            } catch (encodingError) {
                console.error('Error codificando SVG:', encodingError);
                throw new Error('Error creando arte estilizado');
            }
        }
        
        // Crear placeholder de error informativo
        function createErrorPlaceholder(prompt, width, height, seed, styleData, generation) {
            const cleanPrompt = prompt.replace(/[<>&"']/g, '').substring(0, 40);
            const cleanStyleName = styleData.name.replace(/[<>&"']/g, '');
            const svgContent = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="errorGrad${seed}" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ef4444;stop-opacity:0.9" />
                        <stop offset="100%" style="stop-color:#dc2626;stop-opacity:0.9" />
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#errorGrad${seed})"/>
                <text x="50%" y="25%" text-anchor="middle" fill="white" font-size="48" font-family="Arial">‚ö†Ô∏è</text>
                <text x="50%" y="35%" text-anchor="middle" fill="white" font-size="20" font-family="Arial, sans-serif" font-weight="bold">APIs Temporalmente No Disponibles</text>
                <text x="50%" y="45%" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="14" font-family="Arial, sans-serif">Generaci√≥n #${generation} - Sistema en mantenimiento</text>
                <text x="50%" y="55%" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="12" font-family="Arial, sans-serif">Estilo: ${cleanStyleName}</text>
                <text x="50%" y="65%" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="12" font-family="Arial, sans-serif">Prompt: ${cleanPrompt}${cleanPrompt.length >= 40 ? '...' : ''}</text>
                <text x="50%" y="78%" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="10" font-family="Arial, sans-serif">Intenta "üîÑ Nueva Variaci√≥n" en unos minutos</text>
                <text x="50%" y="85%" text-anchor="middle" fill="rgba(255,255,255,0.5)" font-size="10" font-family="Arial, sans-serif">narrativAI | Seed: ${seed}</text>
                <rect x="3" y="3" width="${width-6}" height="${height-6}" fill="none" stroke="#ffffff" stroke-width="2" rx="8" opacity="0.3" stroke-dasharray="10,5"/>
            </svg>`;
            try {
                const encodedSvg = btoa(unescape(encodeURIComponent(svgContent)));
                return {
                    url: `image/svg+xml;base64,${encodedSvg}`,
                    prompt: prompt,
                    originalPrompt: prompt,
                    appliedStyle: styleData.name,
                    styleKeywords: styleData.keywords,
                    width: width,
                    height: height,
                    seed: seed,
                    api: 'Placeholder Error',
                    isRealAI: false,
                    isGenerated: false,
                    isPlaceholder: true,
                    error: 'APIs temporalmente no disponibles',
                    generation: generation
                };
            } catch (encodingError) {
                console.error('Error creando placeholder:', encodingError);
                // Fallback ultra-simple
                return {
                    url: `image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`,
                    prompt: prompt,
                    originalPrompt: prompt,
                    appliedStyle: styleData.name,
                    width: width,
                    height: height,
                    seed: seed,
                    api: 'Placeholder Fallback',
                    isRealAI: false,
                    isGenerated: false,
                    isPlaceholder: true,
                    error: 'Error cr√≠tico',
                    generation: generation
                };
            }
        }
        
        // ==================== MANEJADORES DE EVENTOS ====================
        async function handleGenerateNarrative() {
            if (appState.isGenerating) return;
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnText = document.getElementById('generateBtnText');
            const loadingNarrative = document.getElementById('loadingNarrative');
            const narrativePlaceholder = document.getElementById('narrativePlaceholder');
            const narrativeContent = document.getElementById('narrativeContent');
            try {
                appState.isGenerating = true;
                generateBtn.disabled = true;
                generateBtnText.textContent = 'üé≠ Tejiendo √©pica...';
                loadingNarrative.classList.remove('hidden');
                narrativePlaceholder.classList.add('hidden');
                narrativeContent.classList.add('hidden');
                const narrative = generateNarrative();
                appState.generatedNarrative = narrative;
                // Simular tiempo de procesamiento
                await new Promise(resolve => setTimeout(resolve, 2000));
                loadingNarrative.classList.add('hidden');
                const narrativeDisplay = document.getElementById('narrativeDisplay');
                if (narrativeDisplay) {
                    narrativeDisplay.innerHTML = narrative.replace(/
/g, '<br><br>');
                }
                narrativeContent.classList.remove('hidden');
                updateImageReadyState();
                showNotification('üé≠ ¬°Narrativa √©pica generada! Ahora puedes crear la imagen', 'green');
            } catch (error) {
                console.error('Error en la generaci√≥n:', error);
                showNotification(error.message, 'red');
                loadingNarrative.classList.add('hidden');
                narrativePlaceholder.classList.remove('hidden');
            } finally {
                appState.isGenerating = false;
                generateBtn.disabled = false;
                generateBtnText.textContent = 'üé≠ Generar Narrativa';
            }
        }
        
        async function handleGenerateImage() {
            console.log(`üé® === INICIANDO GENERACI√ìN DE IMAGEN #${appState.currentGeneration + 1} ===`);
            if (!appState.generatedNarrative) {
                showNotification('‚ö†Ô∏è Genera una narrativa primero.', 'yellow');
                return;
            }
            if (appState.isGenerating) {
                console.log('‚ö†Ô∏è Ya hay una generaci√≥n en progreso');
                return;
            }
            const generateImageBtn = document.getElementById('generateImageBtn');
            const generateImageBtnText = document.getElementById('generateImageBtnText');
            const loadingImage = document.getElementById('loadingImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            try {
                appState.isGenerating = true;
                generateImageBtn.disabled = true;
                generateImageBtnText.textContent = 'üé® Creando imagen...';
                imagePlaceholder.classList.add('hidden');
                loadingImage.classList.remove('hidden');
                // Recoger elementos personalizados
                const customElements = [
                    document.getElementById('element1')?.value?.trim() || '',
                    document.getElementById('element2')?.value?.trim() || '',
                    document.getElementById('element3')?.value?.trim() || ''
                ].filter(Boolean);
                // Crear prompt con estilo aplicado
                const imagePrompt = createImagePrompt(appState.generatedNarrative, customElements);
                console.log(`üìù Prompt final enviado a APIs:`, imagePrompt);
                // GENERAR IMAGEN CON SISTEMA ROBUSTO
                const imageResult = await generateImageWithStyle(imagePrompt);
                console.log(`‚úÖ Resultado obtenido:`, imageResult);
                loadingImage.classList.add('hidden');
                displayImage(imageResult);
                // Notificaciones espec√≠ficas
                if (imageResult.isRealAI && !imageResult.isPlaceholder) {
                    showNotification(`üéâ ¬°IMAGEN IA REAL! API: ${imageResult.api}`, 'green');
                } else if (imageResult.isStyled && !imageResult.isPlaceholder) {
                    showNotification(`üé® Arte estilizado: ${imageResult.appliedStyle}`, 'blue');
                } else if (imageResult.isPlaceholder) {
                    showNotification('‚ö†Ô∏è APIs no disponibles - Intenta "üîÑ Nueva Variaci√≥n"', 'yellow');
                } else {
                    showNotification('‚úÖ Imagen creada', 'green');
                }
            } catch (error) {
                console.error(`‚ùå Error en generaci√≥n #${appState.currentGeneration}:`, error);
                loadingImage.classList.add('hidden');
                imagePlaceholder.classList.remove('hidden');
                showNotification('‚ùå Error t√©cnico - Intenta de nuevo', 'red');
            } finally {
                appState.isGenerating = false;
                generateImageBtn.disabled = false;
                generateImageBtnText.textContent = 'üé® Generar Imagen IA';
            }
        }
        
        // ==================== GESTI√ìN DE GALER√çA ====================
        function displayImage(imageResult) {
            console.log('üñºÔ∏è Mostrando imagen en galer√≠a:', imageResult);
            try {
                if (!imageResult || !imageResult.url) {
                    console.error('‚ùå Resultado de imagen inv√°lido');
                    return;
                }
                const placeholder = document.getElementById('imagePlaceholder');
                const gallery = document.getElementById('imageGallery');
                const controls = document.getElementById('imageControls');
                const status = document.getElementById('imageStatus');
                // A√±adir al historial
                const imageData = {
                    ...imageResult,
                    timestamp: Date.now(),
                    id: `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                appState.imageHistory.push(imageData);
                console.log(`üìö Imagen a√±adida. Total: ${appState.imageHistory.length}`);
                // Actualizar UI
                placeholder.classList.add('hidden');
                gallery.classList.remove('hidden');
                controls.classList.remove('hidden');
                renderImageGallery();
                // Mostrar status detallado
                const statusContent = `
                    <div class="text-sm">
                        üé® <strong>Generaci√≥n #${imageResult.generation || '?'}:</strong> ${imageResult.width || 1024}x${imageResult.height || 768}
                        <br>üìê <strong>M√©todo:</strong> ${imageResult.api || 'Desconocido'}
                        <br>üé≠ <strong>Estilo:</strong> ${imageResult.appliedStyle || 'Auto'}
                        ${imageResult.styleKeywords ? `<br>üîß <strong>Keywords:</strong> ${imageResult.styleKeywords.slice(0,3).join(', ')}` : ''}
                        ${imageResult.seed ? `<br>üé≤ <strong>Seed:</strong> ${imageResult.seed}` : ''}
                        ${imageResult.loadTime ? `<br>‚è±Ô∏è <strong>Tiempo:</strong> ${imageResult.loadTime}ms` : ''}
                        ${imageResult.isRealAI ? '<br>‚úÖ <strong>IA REAL:</strong> Generada por API externa' : ''}
                        ${imageResult.isStyled ? '<br>üé® <strong>ARTE ESTILIZADO:</strong> Con estilo personalizado' : ''}
                        ${imageResult.isPlaceholder ? '<br>‚ö†Ô∏è <strong>PLACEHOLDER:</strong> APIs temporalmente no disponibles' : ''}
                        ${imageResult.error ? `<br>‚ùå <strong>Info:</strong> ${imageResult.error}` : ''}
                    </div>
                `;
                status.innerHTML = statusContent;
                status.classList.remove('hidden');
            } catch (error) {
                console.error('‚ùå Error mostrando imagen:', error);
                showNotification('‚ùå Error en la galer√≠a', 'red');
            }
        }
        
        function renderImageGallery() {
            const gallery = document.getElementById('imageGallery');
            if (!gallery || appState.imageHistory.length === 0) {
                return;
            }
            console.log(`üñºÔ∏è Renderizando galer√≠a con ${appState.imageHistory.length} im√°genes`);
            const latestImage = appState.imageHistory[appState.imageHistory.length - 1];
            let galleryHTML = `
                <div class="mb-4 p-4 bg-purple-900/20 rounded-lg border border-purple-500/30">
                    <h4 class="text-sm font-medium text-purple-300 mb-2">üé® Tu Galer√≠a √âpica (${appState.imageHistory.length} ${appState.imageHistory.length === 1 ? 'imagen' : 'im√°genes'})</h4>
                </div>
                <div class="mb-6">
                    <div class="relative group">
                        <img src="${latestImage.url}" 
                             alt="Imagen √©pica actual" 
                             class="w-full h-64 object-cover rounded-lg border-2 border-purple-500 cursor-pointer shadow-lg"
                             onclick="openImageModal('${latestImage.id}')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="hidden w-full h-64 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg border-2 border-purple-500 flex items-center justify-center">
                            <div class="text-center text-white">
                                <div class="text-4xl mb-2">üé≠</div>
                                <p class="text-lg font-bold">Imagen √âpica</p>
                                <p class="text-sm opacity-75">Generada con ${latestImage.api}</p>
                            </div>
                        </div>
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/50 transition-all duration-300 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <div class="text-center text-white">
                                <p class="text-lg font-medium mb-2">Imagen Actual</p>
                                <div class="flex gap-2 justify-center">
                                    <button onclick="openImageModal('${latestImage.id}')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                                        üëÅÔ∏è Ver Detalles
                                    </button>
                                    <button onclick="regenerateImage()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                        üîÑ Nueva Variaci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="absolute top-3 left-3 bg-green-600 text-white px-2 py-1 rounded-lg text-xs font-bold">
                            ‚ú® ACTUAL
                        </div>
                        <div class="absolute top-3 right-3 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                            <p class="text-xs text-white">${latestImage.api}</p>
                        </div>
                    </div>
                </div>
            `;
            // Historial si hay m√°s de una imagen
            if (appState.imageHistory.length > 1) {
                galleryHTML += `
                    <div class="mb-4">
                        <h5 class="text-sm font-medium text-gray-400 mb-3">üìö Historial de Variaciones</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                `;
                appState.imageHistory.slice(0, -1).forEach((imageData, index) => {
                    galleryHTML += `
                        <div class="relative group">
                            <img src="${imageData.url}" 
                                 alt="Imagen √©pica ${index + 1}" 
                                 class="w-full h-32 object-cover rounded-lg border border-gray-600 cursor-pointer hover:scale-105 transition-transform"
                                 onclick="openImageModal('${imageData.id}')"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="hidden w-full h-32 bg-gradient-to-br from-gray-600 to-gray-800 rounded-lg border border-gray-600 flex items-center justify-center">
                                <div class="text-center text-white">
                                    <div class="text-2xl mb-1">üé≠</div>
                                    <p class="text-xs">Imagen #${index + 1}</p>
                                </div>
                            </div>
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/70 transition-all duration-300 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <div class="text-center text-white">
                                    <div class="flex gap-1">
                                        <button onclick="openImageModal('${imageData.id}')" class="px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                            üëÅÔ∏è
                                        </button>
                                        <button onclick="removeImage('${imageData.id}')" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                            ‚ùå
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="absolute top-1 left-1 bg-black/70 backdrop-blur-sm rounded px-1 py-0.5">
                                <p class="text-xs text-green-300">#${index + 1}</p>
                            </div>
                        </div>
                    `;
                });
                galleryHTML += '</div></div>';
            }
            gallery.innerHTML = galleryHTML;
            console.log('‚úÖ Galer√≠a renderizada');
        }
        
        function updateImageReadyState() {
            const placeholderMessage = document.getElementById('placeholderMessage');
            const readyMessage = document.getElementById('readyMessage');
            const generateImageBtn = document.getElementById('generateImageBtn');
            if (appState.generatedNarrative && placeholderMessage && readyMessage) {
                placeholderMessage.classList.add('hidden');
                readyMessage.classList.remove('hidden');
            }
            if (generateImageBtn) {
                generateImageBtn.disabled = !appState.generatedNarrative;
            }
        }
        
        // ==================== EDICI√ìN DE NARRATIVA ====================
        let isEditingNarrative = false;
        let originalNarrativeText = '';
        
        window.toggleNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const narrativeTextarea = document.getElementById('narrativeTextarea');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            const charCount = document.getElementById('charCount');
            if (!isEditingNarrative) {
                // Entrar en modo edici√≥n
                isEditingNarrative = true;
                originalNarrativeText = appState.generatedNarrative;
                // Ocultar vista de lectura y mostrar editor
                narrativeDisplay.classList.add('hidden');
                narrativeEditor.classList.remove('hidden');
                // Configurar textarea con el contenido actual
                narrativeTextarea.value = appState.generatedNarrative;
                updateCharCount();
                // Cambiar botones
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                // Enfocar el textarea
                setTimeout(() => {
                    narrativeTextarea.focus();
                    narrativeTextarea.setSelectionRange(0, 0); // Cursor al inicio
                }, 100);
                console.log('üñäÔ∏è Modo edici√≥n activado');
                showNotification('‚úèÔ∏è Modo edici√≥n activado', 'blue');
            } else {
                // Salir del modo edici√≥n (sin guardar)
                cancelNarrativeEdit();
            }
        };
        
        window.saveNarrativeEdit = function() {
            const narrativeTextarea = document.getElementById('narrativeTextarea');
            const newText = narrativeTextarea.value.trim();
            if (newText === '') {
                showNotification('‚ö†Ô∏è La narrativa no puede estar vac√≠a', 'yellow');
                return;
            }
            if (newText === originalNarrativeText) {
                showNotification('üí° No se detectaron cambios', 'blue');
                cancelNarrativeEdit();
                return;
            }
            // Guardar los cambios
            appState.generatedNarrative = newText;
            // Actualizar la vista de lectura
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            narrativeDisplay.innerHTML = newText.replace(/
/g, '<br><br>');
            // Salir del modo edici√≥n
            exitEditMode();
            console.log('üíæ Narrativa editada y guardada');
            showNotification('üíæ ¬°Cambios guardados exitosamente!', 'green');
            // Limpiar historial de im√°genes si hab√≠a im√°genes previas
            if (appState.imageHistory.length > 0) {
                const shouldClearImages = confirm('üñºÔ∏è ¬øQuieres limpiar las im√°genes anteriores? (La narrativa editada puede generar im√°genes diferentes)');
                if (shouldClearImages) {
                    clearImageHistory();
                    showNotification('üóëÔ∏è Galer√≠a limpiada para nueva narrativa', 'blue');
                }
            }
        };
        
        window.cancelNarrativeEdit = function() {
            const narrativeTextarea = document.getElementById('narrativeTextarea');
            const currentText = narrativeTextarea.value.trim();
            // Verificar si hay cambios
            if (currentText !== originalNarrativeText && currentText !== '') {
                const confirmCancel = confirm('‚ùì ¬øEst√°s seguro de cancelar? Se perder√°n los cambios no guardados.');
                if (!confirmCancel) {
                    return;
                }
            }
            exitEditMode();
            showNotification('‚ùå Edici√≥n cancelada', 'yellow');
            console.log('‚ùå Edici√≥n cancelada - cambios descartados');
        };
        
        function exitEditMode() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            // Salir del modo edici√≥n
            isEditingNarrative = false;
            originalNarrativeText = '';
            // Mostrar vista de lectura y ocultar editor
            narrativeDisplay.classList.remove('hidden');
            narrativeEditor.classList.add('hidden');
            // Restaurar botones
            editBtn.classList.remove('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
        }
        
        function updateCharCount() {
            const narrativeTextarea = document.getElementById('narrativeTextarea');
            const charCount = document.getElementById('charCount');
            if (narrativeTextarea && charCount) {
                const count = narrativeTextarea.value.length;
                charCount.textContent = `${count} caracteres`;
                // Cambiar color seg√∫n la longitud
                if (count < 100) {
                    charCount.className = 'text-red-400';
                } else if (count < 500) {
                    charCount.className = 'text-yellow-400';
                } else {
                    charCount.className = 'text-green-400';
                }
            }
        }
        
        // ==================== FUNCIONES GLOBALES ====================
        window.regenerateImage = async function() {
            console.log(`üîÑ === REGENERANDO IMAGEN (Generaci√≥n #${appState.currentGeneration + 1}) ===`);
            if (!appState.generatedNarrative) {
                showNotification('‚ö†Ô∏è Genera una narrativa primero.', 'yellow');
                return;
            }
            if (appState.isGenerating) {
                console.log('‚ö†Ô∏è Ya hay una regeneraci√≥n en progreso');
                return;
            }
            showNotification('üîÑ Creando nueva variaci√≥n...', 'blue');
            const loadingImage = document.getElementById('loadingImage');
            const gallery = document.getElementById('imageGallery');
            try {
                if (loadingImage) loadingImage.classList.remove('hidden');
                if (gallery) gallery.classList.add('hidden');
                // Marcar como generando
                appState.isGenerating = true;
                const customElements = [
                    document.getElementById('element1')?.value?.trim() || '',
                    document.getElementById('element2')?.value?.trim() || '',
                    document.getElementById('element3')?.value?.trim() || ''
                ].filter(Boolean);
                const regenerationPrompt = createImagePrompt(appState.generatedNarrative, customElements);
                console.log(`üé® Prompt para regeneraci√≥n:`, regenerationPrompt);
                const imageResult = await generateImageWithStyle(regenerationPrompt);
                if (loadingImage) loadingImage.classList.add('hidden');
                if (imageResult && imageResult.url) {
                    displayImage(imageResult);
                    if (imageResult.isRealAI && !imageResult.isPlaceholder) {
                        showNotification(`‚úÖ ¬°Nueva imagen IA real! (${imageResult.api})`, 'green');
                    } else if (imageResult.isStyled && !imageResult.isPlaceholder) {
                        showNotification(`‚úÖ Nueva variaci√≥n estilizada: ${imageResult.appliedStyle}`, 'blue');
                    } else if (imageResult.isPlaceholder) {
                        showNotification('‚ö†Ô∏è Nueva variaci√≥n (APIs no disponibles)', 'yellow');
                    } else {
                        showNotification('‚úÖ Nueva variaci√≥n creada', 'green');
                    }
                } else {
                    throw new Error('No se obtuvo imagen v√°lida');
                }
            } catch (error) {
                console.error(`‚ùå Error en regeneraci√≥n:`, error);
                if (loadingImage) loadingImage.classList.add('hidden');
                if (gallery) gallery.classList.remove('hidden');
                showNotification('‚ùå Error en regeneraci√≥n - Intenta de nuevo', 'red');
            } finally {
                appState.isGenerating = false;
            }
        };
        
        window.clearImageHistory = function() {
            if (confirm('¬øSeguro que quieres limpiar toda la galer√≠a de im√°genes?')) {
                appState.imageHistory = [];
                const gallery = document.getElementById('imageGallery');
                const placeholder = document.getElementById('imagePlaceholder');
                const controls = document.getElementById('imageControls');
                const status = document.getElementById('imageStatus');
                gallery.classList.add('hidden');
                placeholder.classList.remove('hidden');
                controls.classList.add('hidden');
                status.classList.add('hidden');
                showNotification('üóëÔ∏è Galer√≠a limpiada', 'blue');
            }
        };
        
        window.openImageModal = function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.onclick = () => document.body.removeChild(modal);
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full bg-gray-800 rounded-lg overflow-hidden" onclick="event.stopPropagation()">
                    <div class="p-4 border-b border-gray-600">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-purple-400">üé® Detalles de Imagen √âpica</h3>
                            <button onclick="document.body.removeChild(document.querySelector('.fixed'))" class="text-gray-400 hover:text-white text-xl">√ó</button>
                        </div>
                    </div>
                    <div class="p-4">
                        <img src="${imageData.url}" alt="Imagen √©pica" class="w-full rounded-lg mb-4">
                        <div class="text-sm text-gray-300">
                            <p><strong>Generado:</strong> ${new Date(imageData.timestamp).toLocaleString('es-ES')}</p>
                            <p><strong>Dimensiones:</strong> ${imageData.width}x${imageData.height}</p>
                            <p><strong>Estilo:</strong> ${imageData.appliedStyle}</p>
                            <p><strong>API:</strong> ${imageData.api}</p>
                            ${imageData.generation ? `<p><strong>Generaci√≥n #:</strong> ${imageData.generation}</p>` : ''}
                            <p class="mt-2"><strong>Prompt:</strong></p>
                            <p class="text-xs font-mono bg-gray-900/50 p-3 rounded mt-1">${imageData.prompt}</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        window.removeImage = function(imageId) {
            if (confirm('¬øEliminar esta imagen de la galer√≠a?')) {
                appState.imageHistory = appState.imageHistory.filter(img => img.id !== imageId);
                if (appState.imageHistory.length === 0) {
                    clearImageHistory();
                } else {
                    renderImageGallery();
                }
                showNotification('üóëÔ∏è Imagen eliminada', 'blue');
            }
        };
        
        window.downloadProject = async function() {
            if (!appState.generatedNarrative) {
                showNotification('‚ö†Ô∏è Genera una narrativa primero.', 'yellow');
                return;
            }
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'üì¶ Creando ZIP...';
            downloadBtn.disabled = true;
            try {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                // Contenido markdown
                let markdownContent = '# üé≠ Tu Narrativa √âpica - narrativAI
';
                markdownContent += '**Proyecto generado el:** ' + new Date().toLocaleString('es-ES') + '
';
                markdownContent += '## üìñ Tu Historia √âpica
';
                markdownContent += appState.generatedNarrative + '
';
                markdownContent += '## ‚öñÔ∏è Configuraci√≥n de G√©neros
';
                markdownContent += '**G√©neros seleccionados:** ' + appState.selectedGenres.map(id => genres[id].icon + ' ' + genres[id].name + ' (' + (appState.genreIntensities[id] || 70) + '%)').join(', ') + '
';
                const element1 = document.getElementById('element1').value || 'No especificado';
                const element2 = document.getElementById('element2').value || 'No especificado';
                const element3 = document.getElementById('element3').value || 'No especificado';
                markdownContent += '## üéØ Elementos Personalizados
';
                markdownContent += '- **üéØ Principal:** ' + element1 + '
';
                markdownContent += '- **üî∏ Secundario:** ' + element2 + '
';
                markdownContent += '- **üèõÔ∏è Contexto:** ' + element3 + '
';
                if (appState.imageHistory.length > 0) {
                    markdownContent += '## üé® Galer√≠a de Im√°genes
';
                    markdownContent += `**Total de im√°genes generadas:** ${appState.imageHistory.length}
`;
                    appState.imageHistory.forEach((img, index) => {
                        markdownContent += `### Imagen ${index + 1}
`;
                        markdownContent += `- **Estilo:** ${img.appliedStyle}
`;
                        markdownContent += `- **API:** ${img.api}
`;
                        markdownContent += `- **Dimensiones:** ${img.width}x${img.height}
`;
                        if (img.generation) markdownContent += `- **Generaci√≥n #:** ${img.generation}
`;
                        markdownContent += `- **Generada:** ${new Date(img.timestamp).toLocaleString('es-ES')}
`;
                    });
                }
                markdownContent += '
---
*Generado con ‚ù§Ô∏è por **narrativAI*** üé≠‚ú®';
                zip.file('narrativa.md', markdownContent);
                // A√±adir im√°genes si existen
                if (appState.imageHistory.length > 0) {
                    for (let i = 0; i < appState.imageHistory.length; i++) {
                        try {
                            const response = await fetch(appState.imageHistory[i].url);
                            const blob = await response.blob();
                            zip.file(`imagen-${String(i + 1).padStart(2, '0')}.jpg`, blob);
                        } catch (error) {
                            console.warn('Error a√±adiendo imagen:', error);
                        }
                    }
                }
                // README
                let readmeContent = 'üì¶ PROYECTO NARRATIVAI - TU √âPICA COMPLETA
';
                readmeContent += '==========================================
';
                readmeContent += 'üé≠ ¬°Tu leyenda est√° lista!
';
                readmeContent += 'Contenido del proyecto:
';
                readmeContent += '- narrativa.md: Tu historia √©pica completa
';
                readmeContent += appState.imageHistory.length > 0 ? `- ${appState.imageHistory.length} im√°genes √©picas generadas
` : '';
                readmeContent += '- README.txt: Este archivo
';
                readmeContent += '‚ú® Generado con narrativAI
';
                readmeContent += 'Fecha: ' + new Date().toLocaleString('es-ES') + '
';
                zip.file('README.txt', readmeContent);
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `narrativAI-epica-${timestamp}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('üéâ ¬°Proyecto descargado exitosamente!', 'green');
            } catch (error) {
                console.error('Error creando proyecto ZIP:', error);
                showNotification('‚ö†Ô∏è Error creando el archivo ZIP.', 'red');
            } finally {
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        };
        
        // ==================== INICIALIZACI√ìN ====================
        function setupEventListeners() {
            console.log('üîó Configurando event listeners...');
            // Bot√≥n de narrativa
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.removeEventListener('click', handleGenerateNarrative);
                generateBtn.addEventListener('click', handleGenerateNarrative);
                console.log('‚úÖ Listener de narrativa configurado');
            }
            // Bot√≥n de imagen
            const generateImageBtn = document.getElementById('generateImageBtn');
            if (generateImageBtn) {
                generateImageBtn.removeEventListener('click', handleGenerateImage);
                generateImageBtn.addEventListener('click', handleGenerateImage);
                generateImageBtn.disabled = !appState.generatedNarrative;
                console.log('‚úÖ Listener de imagen configurado');
            }
            // Selector de estilo art√≠stico con logging
            const artStyleSelect = document.getElementById('artStyle');
            if (artStyleSelect) {
                artStyleSelect.addEventListener('change', function(e) {
                    const selectedStyle = e.target.value;
                    const styleData = artisticStyles[selectedStyle] || artisticStyles['auto'];
                    console.log(`üé® ESTILO CAMBIADO A: "${styleData.name}"`);
                    console.log(`üìù Prompt t√©cnico: ${styleData.prompt.substring(0, 100)}...`);
                    showNotification(`üé® Estilo seleccionado: ${styleData.name}`, 'blue');
                });
                console.log('‚úÖ Listener de selector de estilo configurado');
            }
            // Configurar listeners del editor de narrativa
            setupNarrativeEditorListeners();
        }
        
        function setupNarrativeEditorListeners() {
            // Listener para el contador de caracteres en tiempo real
            const narrativeTextarea = document.getElementById('narrativeTextarea');
            if (narrativeTextarea) {
                narrativeTextarea.addEventListener('input', updateCharCount);
                // Atajos de teclado para el editor
                narrativeTextarea.addEventListener('keydown', function(e) {
                    // Ctrl/Cmd + S para guardar
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        saveNarrativeEdit();
                        return;
                    }
                    // Escape para cancelar
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelNarrativeEdit();
                        return;
                    }
                    // Ctrl/Cmd + Enter para guardar y generar imagen
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        saveNarrativeEdit();
                        // Generar imagen autom√°ticamente despu√©s de guardar
                        setTimeout(() => {
                            if (!appState.isGenerating) {
                                handleGenerateImage();
                            }
                        }, 500);
                        return;
                    }
                });
                console.log('‚úÖ Listeners del editor de narrativa configurados');
            }
        }
        
        function initializeApp() {
            try {
                console.log('üöÄ === INICIANDO NARRATIVAI CORREGIDO ===');
                console.log('üìä Sistema robusto de generaci√≥n m√∫ltiple activado');
                
                createGenreElements();
                updateGenreCount();
                setupEventListeners();
                setupApiConfiguration(); // NUEVO: Configuraci√≥n de API
                updateImageReadyState();
                updateOpenrouterStatus(!!appState.openrouterApiKey);
                
                // Log de verificaci√≥n
                console.log('‚úÖ Componentes inicializados:');
                console.log('- G√©neros:', Object.keys(genres).length);
                console.log('- Estilos art√≠sticos:', Object.keys(artisticStyles).length);
                console.log('- Proveedor activo:', appState.activeImageProvider);
                console.log('- OpenRouter configurado:', !!appState.openrouterApiKey);
                console.log('- Estado inicial:', appState);
                
                setTimeout(() => {
                    showNotification('üé≠ narrativAI listo - ¬°Soporte para OpenRouter a√±adido!', 'purple');
                }, 500);
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                setTimeout(() => {
                    showNotification('‚ùå Error de inicializaci√≥n - Recarga la p√°gina', 'red');
                }, 1000);
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
