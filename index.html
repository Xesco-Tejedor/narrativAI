<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ narrativAI - Generador de √âpicas con IA REAL</title>
    <meta name="description" content="Genera narrativas √©picas y arte de IA con estilos art√≠sticos reales. Usa APIs de Pollinations y OpenRouter para crear historias e im√°genes √∫nicas.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }
        .genre-card:hover:not(.selected) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
    </style>
</head>
<body class="text-white">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-purple-600/20 via-pink-600/20 to-yellow-600/20 py-8 mb-8">
        <div class="container mx-auto px-4 max-w-6xl">
            <div class="text-center">
                <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-yellow-500 bg-clip-text text-transparent mb-4">
                    üé≠ narrativAI
                </h1>
                <p class="text-xl md:text-2xl text-gray-300 mb-2">
                    Motor de Narrativas √âpicas + Generaci√≥n de Im√°genes IA REAL
                </p>
                <p class="text-lg text-purple-300 mb-6">
                    ‚ú® APIs reales de Pollinations AI + OpenRouter + Arte estilizado
                </p>
            </div>
        </div>
    </div>
    <!-- Nueva secci√≥n de configuraci√≥n de API -->
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700 mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">‚öôÔ∏è</div>
                    <h2 class="text-2xl font-bold text-blue-400">Configuraci√≥n de API</h2>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-blue-300 mb-2 flex items-center">
                        üîë OpenRouter API Key (opcional)
                    </label>
                    <div class="relative">
                        <input type="password" id="openrouterApiKey" 
                               placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                               class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30 text-white transition-all pr-10">
                        <button id="toggleApiKeyVisibility" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-400"
                                title="Mostrar/ocultar clave API">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">
                        Ingresa tu clave API gratuita de <a href="https://openrouter.ai/" target="_blank" class="text-blue-400 hover:underline">openrouter.ai</a> para usar modelos adicionales.
                        <br>Se almacena localmente en tu navegador (no se env√≠a a ning√∫n servidor).
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-300 mb-2">
                        üß™ Proveedor de Im√°genes Activo
                    </label>
                    <select id="imageProvider" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500">
                        <option value="pollinations">Pollinations AI (predeterminado)</option>
                        <option value="openrouter">OpenRouter AI (requiere clave)</option>
                    </select>
                    <div id="openrouterStatus" class="mt-2 text-xs p-2 rounded bg-gray-700/50">
                        <span class="text-yellow-400">‚ö†Ô∏è</span> OpenRouter no configurado - Ingresa tu clave API arriba
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container mx-auto px-4 max-w-6xl space-y-8">
        <!-- Paso 1: Elementos Clave -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">1</div>
                <div>
                    <h2 class="text-2xl font-bold text-purple-400">Define Tus Elementos Clave</h2>
                    <p class="text-gray-300">Introduce hasta tres elementos para tu narrativa √©pica</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">
                        üéØ Personaje o Elemento Central
                    </label>
                    <input type="text" id="element1" placeholder="ej: un valiente caballero, el √∫ltimo drag√≥n..." 
                           class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">
                        üî∏ Entorno o Elemento de Apoyo
                    </label>
                    <input type="text" id="element2" placeholder="ej: una biblioteca perdida, un sabio ermita√±o..." 
                           class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-300 mb-2">
                        üèõÔ∏è Atm√≥sfera o Concepto
                    </label>
                    <input type="text" id="element3" placeholder="ej: un futuro dist√≥pico, un ritual olvidado..." 
                           class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all">
                </div>
            </div>
        </div>
        <!-- Paso 2: G√©neros -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-yellow-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">2</div>
                <div>
                    <h2 class="text-2xl font-bold text-pink-400">Equilibra los G√©neros</h2>
                    <p class="text-gray-300">Selecciona hasta 3 g√©neros y ajusta su intensidad</p>
                </div>
            </div>
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-purple-400">
                    üé≠ Selecciona g√©neros (m√°ximo 3)
                </h3>
                <span id="genreCount" class="text-sm bg-gradient-to-r from-purple-600 to-pink-600 px-3 py-1 rounded-full font-medium">0/3</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="genreGrid">
                <!-- G√©neros se generan din√°micamente -->
            </div>
            <!-- Controles de intensidad -->
            <div id="genreIntensityControls" class="hidden">
                <div class="bg-gray-900/50 rounded-xl p-6 border border-purple-500/30">
                    <h4 class="text-lg font-medium text-purple-300 mb-4 flex items-center">
                        ‚öñÔ∏è Control de Intensidad
                        <div class="ml-4 text-sm bg-green-600 px-2 py-1 rounded-full" id="totalDisplay">100%</div>
                    </h4>
                    <div id="genreSliders" class="space-y-4">
                        <!-- Sliders se generan din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Paso 3: Generar -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- 3.1 Narrativa -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-sm font-bold mr-3">3.1</div>
                        <div>
                            <h3 class="text-xl font-bold text-yellow-400">Genera Narrativa</h3>
                            <p class="text-gray-300 text-sm">Tu historia √©pica estructurada</p>
                        </div>
                    </div>
                    <button id="generateBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="generateBtnText">üé≠ Generar Narrativa</span>
                    </button>
                </div>
                <div id="narrativePlaceholder" class="text-center text-gray-400 py-12 border-2 border-dashed border-gray-600 rounded-lg">
                    <div class="text-4xl mb-3">üìö</div>
                    <p class="text-lg">¬°Completa los elementos y g√©neros para comenzar!</p>
                </div>
                <div id="narrativeContent" class="hidden">
                    <div class="bg-gray-900/50 rounded-lg p-6 border border-purple-500/30">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm text-purple-300 font-medium">üìù Tu Narrativa √âpica</span>
                            <div class="flex gap-2">
                                <button id="editNarrativeBtn" onclick="toggleNarrativeEdit()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button id="saveNarrativeBtn" onclick="saveNarrativeEdit()" class="hidden px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-colors">
                                    üíæ Guardar
                                </button>
                                <button id="cancelNarrativeBtn" onclick="cancelNarrativeEdit()" class="hidden px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition-colors">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                        <!-- Vista de lectura -->
                        <div id="narrativeDisplay" class="text-gray-100 leading-relaxed text-lg"></div>
                        <!-- Editor de texto -->
                        <div id="narrativeEditor" class="hidden">
                            <textarea id="narrativeTextarea" 
                                      class="w-full h-64 p-4 bg-gray-800 border border-gray-600 rounded-lg text-gray-100 leading-relaxed text-lg resize-none focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30"
                                      placeholder="Edita tu narrativa √©pica aqu√≠..."></textarea>
                            <div class="mt-2 text-xs text-gray-400 flex justify-between">
                                <span>üí° Tip: Los cambios se aplicar√°n autom√°ticamente al generar nuevas im√°genes</span>
                                <span id="charCount">0 caracteres</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                        <p class="text-sm text-green-300">
                            ‚úÖ <strong>Narrativa estructurada:</strong> Establecimiento ‚Üí Desarrollo ‚Üí Cl√≠max ‚Üí Resoluci√≥n
                        </p>
                    </div>
                </div>
                <div id="loadingNarrative" class="hidden text-center py-8">
                    <div class="loading-animation text-4xl mb-3">üé≠</div>
                    <p class="text-purple-300 text-lg">Tejiendo tu narrativa √©pica...</p>
                </div>
            </div>
            <!-- 3.2 Im√°genes IA REAL -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-sm font-bold mr-3">3.2</div>
                        <div>
                            <h3 class="text-xl font-bold text-purple-400">Generaci√≥n IA REAL</h3>
                            <p class="text-gray-300 text-sm">APIs reales + Arte estilizado robusto</p>
                        </div>
                    </div>
                    <button id="generateImageBtn" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="generateImageBtnText">üé® Generar Imagen IA</span>
                    </button>
                </div>
                <!-- Selector de Estilo Art√≠stico CORREGIDO -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-purple-300 mb-3">
                        üé® Estilo Art√≠stico
                    </label>
                    <select id="artStyle" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500">
                        <option value="auto">ü§ñ Autom√°tico (adapta el estilo a tu narrativa)</option>
                        <option value="lorenzale-allegory-style">üèõÔ∏è Claudi Lorenzale - Alegor√≠a rom√°ntico-nazarena</option>
                        <option value="rackham-style">üßö Arthur Rackham - Pen & ink con acuarelas delicadas</option>
                        <option value="wrightson-style">üíÄ Bernie Wrightson - Tinta maestra con claroscuro dram√°tico</option>
                        <option value="moebius-style">üåå Moebius - L√≠neas limpias sci-fi, paisajes et√©reos</option>
                        <option value="frazetta-style">‚öîÔ∏è Frank Frazetta - Pinceladas poderosas, anatom√≠a heroica</option>
                        <option value="brom-style">üåô Gerald Brom - Fantas√≠a oscura digital, g√≥tico contempor√°neo</option>
                        <option value="giger-style">üëæ H.R. Giger - Biomec√°nico alien√≠gena, aer√≥grafo monocrom√°tico</option>
                        <option value="photorealistic">üì∏ Fotorrealista - Calidad fotogr√°fica profesional</option>
                        <option value="digital-art">üñ•Ô∏è Arte Digital - Ilustraci√≥n moderna vectorial</option>
                        <option value="oil-painting">üé® Pintura al √ìleo - T√©cnica tradicional, pinceladas visibles</option>
                        <option value="anime">üáØüáµ Anime/Manga - Ojos expresivos, coloreado cel-shaded</option>
                        <option value="comic-book">üìö C√≥mic - Contornos audaces, colores primarios</option>
                        <option value="fantasy-art">üßô‚Äç‚ôÇÔ∏è Arte Fant√°stico - Realismo m√°gico, criaturas mitol√≥gicas</option>
                    </select>
                </div>
                <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                    <div class="text-3xl mb-2">üé®</div>
                    <div id="placeholderMessage">
                        <p class="text-sm">Genera una narrativa primero, luego crea tu imagen √©pica</p>
                    </div>
                    <div id="readyMessage" class="hidden">
                        <p class="text-sm text-green-300">‚úÖ ¬°Narrativa lista! Ahora puedes generar imagen</p>
                    </div>
                </div>
                <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                    <div class="loading-animation text-3xl mb-2">üöÄ</div>
                    <p class="text-purple-300 text-sm">Generando imagen √©pica con IA REAL...</p>
                    <div class="mt-4 w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full animate-pulse" style="width: 80%"></div>
                    </div>
                </div>
                <!-- Galer√≠a de im√°genes -->
                <div id="imageGallery" class="hidden space-y-4">
                    <!-- Las im√°genes se a√±adir√°n aqu√≠ din√°micamente -->
                </div>
                <div id="imageStatus" class="mt-3 p-3 bg-green-900/30 rounded-lg border border-green-500/50 text-sm text-green-300 hidden">
                    <!-- Status se actualiza din√°micamente -->
                </div>
                <!-- Controles de imagen -->
                <div id="imageControls" class="hidden mt-4 flex flex-wrap gap-2">
                    <button onclick="regenerateImage()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition-colors">
                        üîÑ Nueva Variaci√≥n
                    </button>
                    <button onclick="clearImageHistory()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">
                        üóëÔ∏è Limpiar Galer√≠a
                    </button>
                </div>
            </div>
        </div>
        <!-- Paso 4: Exportar -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">4</div>
                    <div>
                        <h2 class="text-2xl font-bold text-green-400">Exporta Tu Proyecto</h2>
                        <p class="text-gray-300">Descarga todo en un ZIP completo</p>
                    </div>
                </div>
                <button onclick="downloadProject()" id="downloadBtn" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50">
                    üì¶ Descargar ZIP
                </button>
            </div>
            <div id="exportStatus" class="text-center text-gray-400 py-8">
                <div class="text-4xl mb-3">üì¶</div>
                <p class="text-lg">Genera tu narrativa para activar la exportaci√≥n</p>
            </div>
        </div>
    </div>
<script>
    // ==================== ESTADO DE LA APLICACI√ìN ====================
    let appState = {
        selectedGenres: [],
        genreIntensities: {},
        generatedNarrative: '',
        imageHistory: [],
        isGenerating: false,
        currentGeneration: 0,
        openrouterApiKey: localStorage.getItem('openrouterApiKey') || '',
        activeImageProvider: localStorage.getItem('activeImageProvider') || 'pollinations'
    };

    // ==================== G√âNEROS DISPONIBLES ====================
    const genres = {
        'terror': { name: 'Terror', icon: 'üëª', color: 'from-red-600 to-red-800' },
        'fantasia': { name: 'Fantas√≠a', icon: 'üßô‚Äç‚ôÇÔ∏è', color: 'from-purple-600 to-purple-800' },
        'romance': { name: 'Romance', icon: 'üíï', color: 'from-pink-600 to-pink-800' },
        'misterio': { name: 'Misterio', icon: 'üîç', color: 'from-yellow-600 to-yellow-800' },
        'ciencia-ficcion': { name: 'Ciencia Ficci√≥n', icon: 'üöÄ', color: 'from-blue-600 to-blue-800' },
        'aventura': { name: 'Aventura', icon: '‚öîÔ∏è', color: 'from-green-600 to-green-800' },
        'comedia': { name: 'Comedia', icon: 'üòÑ', color: 'from-orange-600 to-orange-800' },
        'drama': { name: 'Drama', icon: 'üé≠', color: 'from-indigo-600 to-indigo-800' }
    };

    // ==================== ESTILOS ART√çSTICOS ====================
    const artisticStyles = {
        'auto': {
            name: 'Autom√°tico',
            prompt: 'epic fantasy art, masterpiece quality, professional illustration, cinematic lighting',
            keywords: ['epic', 'fantasy', 'professional', 'cinematic']
        },
        'lorenzale-allegory-style': {
            name: 'Claudi Lorenzale i Sugra√±es',
            prompt: 'masterpiece in the style of Claudi Lorenzale i Sugra√±es, 19th century Romantic-Nazarene Catalan painter, precise academic drawing with clear contours, idealized female figures with classical beauty, serene melancholic expressions, flowing classical drapery, warm golden and earth tone palette, balanced neoclassical composition, allegory of moral virtues, soft diffused lighting, meticulous anatomical detail, Barcelona romantic school painting',
            keywords: ['Lorenzale', 'romantic painting', 'academic drawing', 'allegorical', 'classical', 'Catalan school']
        },
        'rackham-style': {
            name: 'Arthur Rackham',
            prompt: 'Arthur Rackham style illustration, intricate pen and ink linework, delicate watercolor washes, sinuous organic lines, muted earth tones with touches of gold, fairy tale atmosphere, detailed crosshatching, golden age book illustration, mystical folklore',
            keywords: ['pen and ink', 'watercolor', 'fairy tale', 'crosshatching', 'organic lines']
        },
        // ... (other styles remain unchanged)
    };

    // ==================== NOTIFICACIONES ====================
    function showNotification(message, type) {
        console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
        try {
            const colors = {
                'green': 'bg-green-600',
                'yellow': 'bg-yellow-600',
                'red': 'bg-red-600',
                'blue': 'bg-blue-600',
                'purple': 'bg-purple-600'
            };
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type] || 'bg-gray-600'} text-white px-4 py-2 rounded-lg z-50 max-w-sm shadow-lg transition-all duration-300`;
            notification.textContent = message;
            if (document.body) {
                document.body.appendChild(notification);
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, type === 'red' ? 6000 : 3000);
            }
        } catch (error) {
            console.error('Error creando notificaci√≥n:', error);
        }
    }

    // ==================== CONFIGURACI√ìN DE API ====================
    function setupApiConfiguration() {
        const apiKeyInput = document.getElementById('openrouterApiKey');
        const toggleVisibilityBtn = document.getElementById('toggleApiKeyVisibility');
        const imageProviderSelect = document.getElementById('imageProvider');
        const openrouterStatus = document.getElementById('openrouterStatus');

        if (appState.openrouterApiKey) {
            apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            updateOpenrouterStatus(true);
        }

        toggleVisibilityBtn.addEventListener('click', function() {
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                this.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                apiKeyInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        apiKeyInput.addEventListener('change', function() {
            const apiKey = this.value.trim();
            if (apiKey) {
                appState.openrouterApiKey = apiKey;
                localStorage.setItem('openrouterApiKey', apiKey);
                this.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateOpenrouterStatus(true);
            } else {
                appState.openrouterApiKey = '';
                localStorage.removeItem('openrouterApiKey');
                updateOpenrouterStatus(false);
            }
        });

        imageProviderSelect.value = appState.activeImageProvider;
        updateOpenrouterStatus(!!appState.openrouterApiKey);

        imageProviderSelect.addEventListener('change', function() {
            appState.activeImageProvider = this.value;
            localStorage.setItem('activeImageProvider', this.value);
            updateOpenrouterStatus(!!appState.openrouterApiKey);
        });
    }

    function updateOpenrouterStatus(hasApiKey) {
        const openrouterStatus = document.getElementById('openrouterStatus');
        const imageProviderSelect = document.getElementById('imageProvider');
        if (imageProviderSelect.value === 'openrouter') {
            if (hasApiKey) {
                openrouterStatus.innerHTML = '<span class="text-green-400">‚úì</span> OpenRouter configurado correctamente';
            } else {
                openrouterStatus.innerHTML = '<span class="text-yellow-400">‚ö†Ô∏è</span> OpenRouter no configurado - Ingresa tu clave API arriba';
            }
        } else {
            openrouterStatus.innerHTML = '<span class="text-blue-400">‚ÑπÔ∏è</span> Usando Pollinations AI como proveedor predeterminado';
        }
    }

    // ==================== GESTI√ìN DE G√âNEROS ====================
    function createGenreElements() {
        const genreGrid = document.getElementById('genreGrid');
        Object.keys(genres).forEach(genreId => {
            const genre = genres[genreId];
            const genreCard = document.createElement('div');
            genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
            genreCard.dataset.genreId = genreId;
            genreCard.innerHTML = `
                <div class="text-3xl mb-2">${genre.icon}</div>
                <div class="text-sm font-medium">${genre.name}</div>
            `;
            genreCard.addEventListener('click', () => toggleGenre(genreId));
            genreGrid.appendChild(genreCard);
        });
    }

    function toggleGenre(genreId) {
        const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
        const isSelected = appState.selectedGenres.includes(genreId);
        if (isSelected) {
            appState.selectedGenres = appState.selectedGenres.filter(g => g !== genreId);
            genreCard.classList.remove('selected');
            delete appState.genreIntensities[genreId];
        } else {
            if (appState.selectedGenres.length < 3) {
                appState.selectedGenres.push(genreId);
                genreCard.classList.add('selected');
                appState.genreIntensities[genreId] = 33;
            } else {
                showNotification('‚ö†Ô∏è Ya tienes 3 g√©neros. Deselecciona uno primero.', 'yellow');
                return;
            }
        }
        updateGenreCount();
        updateGenreIntensityControls();
    }

    function updateGenreCount() {
        const genreCount = document.getElementById('genreCount');
        genreCount.textContent = `${appState.selectedGenres.length}/3`;
    }

    window.updateGenreIntensity = function(genreId, value) {
        const newValue = parseInt(value);
        const otherGenres = appState.selectedGenres.filter(id => id !== genreId);
        
        appState.genreIntensities[genreId] = newValue;

        const remaining = 100 - newValue;
        if (otherGenres.length > 0) {
            const base = Math.floor(remaining / otherGenres.length);
            let remainder = remaining % otherGenres.length;
            otherGenres.forEach(id => {
                const add = remainder > 0 ? 1 : 0;
                appState.genreIntensities[id] = base + add;
                remainder--;
            });
        }

        appState.selectedGenres.forEach(id => {
            const slider = document.getElementById(`intensity-${id}`);
            const valueSpan = document.getElementById(`intensity-value-${id}`);
            if (slider) slider.value = appState.genreIntensities[id];
            if (valueSpan) valueSpan.textContent = `${appState.genreIntensities[id]}%`;
        });

        updateTotalIndicator();
    };

    function updateTotalIndicator() {
        const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
        const totalDisplay = document.getElementById('totalDisplay');
        if (totalDisplay) {
            totalDisplay.textContent = `${total}%`;
            totalDisplay.className = total === 100 
                ? 'ml-4 text-sm bg-green-600 px-2 py-1 rounded-full' 
                : 'ml-4 text-sm bg-yellow-600 px-2 py-1 rounded-full';
        }
    }

    function updateGenreIntensityControls() {
        const controlsSection = document.getElementById('genreIntensityControls');
        const slidersContainer = document.getElementById('genreSliders');
        if (appState.selectedGenres.length === 0) {
            controlsSection.classList.add('hidden');
            return;
        }
        controlsSection.classList.remove('hidden');
        slidersContainer.innerHTML = '';
        appState.selectedGenres.forEach(genreId => {
            const genre = genres[genreId];
            const intensity = appState.genreIntensities[genreId] || 33;
            const sliderHtml = `
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${genre.icon}</span>
                            <span class="font-medium text-gray-200">${genre.name}</span>
                        </div>
                        <span id="intensity-value-${genreId}" class="text-sm font-bold text-purple-300 bg-purple-900/30 px-2 py-1 rounded">
                            ${intensity}%
                        </span>
                    </div>
                    <input type="range" 
                           id="intensity-${genreId}" 
                           min="1" 
                           max="98" 
                           value="${intensity}"
                           class="w-full accent-purple-500 h-2 rounded-lg appearance-none bg-gray-700"
                           oninput="updateGenreIntensity('${genreId}', this.value)">
                </div>
            `;
            slidersContainer.innerHTML += sliderHtml;
        });
        updateTotalIndicator();
    }

    // ==================== GENERACI√ìN DE NARRATIVA ====================
    function generateNarrative() {
        const element1 = document.getElementById('element1').value.trim();
        const element2 = document.getElementById('element2').value.trim();
        const element3 = document.getElementById('element3').value.trim();
        if (!element1 && !element2 && !element3) {
            throw new Error('üéØ Ingresa al menos un elemento para comenzar tu √©pica.');
        }
        if (appState.selectedGenres.length === 0) {
            throw new Error('üé≠ Selecciona al menos un g√©nero para dar forma a tu historia.');
        }
        const elements = [element1, element2, element3].filter(Boolean);
        const genreNames = appState.selectedGenres.map(id => genres[id].name);
        const dominantGenres = appState.selectedGenres
            .map(id => ({
                id,
                name: genreNames[appState.selectedGenres.indexOf(id)],
                intensity: appState.genreIntensities[id] || 70
            }))
            .sort((a, b) => b.intensity - a.intensity);
        let narrativeStyle = '';
        if (dominantGenres[0]?.intensity > 85) {
            narrativeStyle = `Con una fuerte influencia de ${dominantGenres[0].name.toLowerCase()}, `;
        } else if (dominantGenres.length > 1) {
            narrativeStyle = `Balanceando elementos de ${dominantGenres.map(g => g.name.toLowerCase()).join(' y ')}, `;
        }
        const narratives = [
            `${narrativeStyle}en las profundidades de ${element2 || 'un lugar misterioso'}, donde ${element3 || 'objetos antiguos'} guardan secretos milenarios, ${element1 || 'nuestro protagonista'} descubre que su destino est√° entrelazado con fuerzas m√°s all√° de su comprensi√≥n.`,
            `${narrativeStyle}cuando ${element1 || 'el protagonista'} se encuentra frente a ${element2 || 'lo desconocido'}, la presencia de ${element3 || 'elementos m√≠sticos'} revela verdades que cambiar√°n el curso de esta historia donde ${genreNames.join(' y ').toLowerCase()} se entrelazan.`,
            `Los elementos se entrelazan en una danza c√≥smica: ${elements.join(', ')} se convierten en las piezas fundamentales de una narrativa que ${narrativeStyle}trasciende los g√©neros de ${genreNames.join(', ')}, creando algo completamente nuevo y extraordinario.`,
            `En este universo donde ${genreNames.map(name => name.toLowerCase()).join(' se fusiona con ')} en perfecta armon√≠a, ${narrativeStyle}cada elemento cobra vida propia. ${element1 || 'El protagonista'} debe navegar entre ${element2 || 'm√∫ltiples realidades'} mientras ${element3 || 'fuerzas ancestrales'} despiertan para revelar los secretos m√°s profundos de la existencia.`
        ];
        return narratives.join('\n');
    }

    // ==================== TRADUCCI√ìN DE PROMPT ====================
    function translateToEnglish(text) {
        if (!text) return text;
        const translations = {
            'y': 'and', 'o': 'or', 'en': 'in', 'el': 'the', 'la': 'the', 'los': 'the', 'las': 'the',
            'un': 'a', 'una': 'a', 'de': 'of', 'del': 'of the', 'con': 'with',
            'historia': 'story', 'narrativa': 'narrative', 'aventura': 'adventure', 'cuento': 'tale',
            'protagonista': 'protagonist', 'personaje': 'character', 'h√©roe': 'hero', 'hero√≠na': 'heroine',
            'castillo': 'castle', 'biblioteca': 'library', 'bosque': 'forest', 'monta√±a': 'mountain',
            'oc√©ano': 'ocean', 'templo': 'temple', 'cueva': 'cave', 'torre': 'tower',
            'libro': 'book', 'espada': 'sword', 'cristal': 'crystal', 'drag√≥n': 'dragon',
            'mago': 'wizard', 'hada': 'fairy', 'magia': 'magic',
            'terror': 'horror', 'fantasia': 'fantasy', 'romance': 'romance', 'misterio': 'mystery',
            'ciencia ficcion': 'science fiction', 'comedia': 'comedy', 'drama': 'drama',
            'pececillo de plata': 'silverfish creature',
            'biblioteca gigantesca': 'gigantic library',
            'fuerzas ancestrales': 'ancestral forces',
            'elementos m√≠sticos': 'mystical elements'
        };

        let result = text.toLowerCase();
        const sortedKeys = Object.keys(translations).sort((a, b) => b.length - a.length);
        sortedKeys.forEach(key => {
            const regex = new RegExp(`\\b${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
            result = result.replace(regex, translations[key]);
        });
        return result.replace(/\s+/g, ' ').trim();
    }

    // ==================== CREAR PROMPT DE IMAGEN ====================
    function createImagePrompt(narrative, customElements) {
        const artStyleSelect = document.getElementById('artStyle');
        const selectedStyle = artStyleSelect ? artStyleSelect.value : 'auto';
        const styleData = artisticStyles[selectedStyle] || artisticStyles['auto'];
        console.log(`üé® APLICANDO ESTILO: "${styleData.name}"`);
        let promptParts = [styleData.prompt];
        if (customElements.length > 0) {
            customElements.forEach((element, index) => {
                const translatedElement = translateToEnglish(element);
                if (index === 0) {
                    promptParts.push(`featuring ${translatedElement} as main subject`);
                } else {
                    promptParts.push(`with ${translatedElement}`);
                }
            });
        }
        const lowerText = narrative.toLowerCase();
        let baseMood = 'epic scene';
        if (lowerText.includes('dark') || lowerText.includes('shadow')) baseMood = 'dark mysterious scene';
        else if (lowerText.includes('magic') || lowerText.includes('mystical')) baseMood = 'magical enchanting scene';
        else if (lowerText.includes('romantic') || lowerText.includes('love')) baseMood = 'romantic warm scene';
        else if (lowerText.includes('horror') || lowerText.includes('terror')) baseMood = 'horror terrifying scene';
        else if (lowerText.includes('adventure') || lowerText.includes('heroic')) baseMood = 'adventurous heroic scene';
        promptParts.push(baseMood);
        promptParts.push(styleData.keywords.slice(0, 3).join(', '));
        promptParts.push('professional artwork, masterpiece quality');
        return promptParts.join(', ');
    }

    // ==================== GENERAR CON OPENROUTER ====================
    async function generateWithOpenRouter(prompt, width, height, seed, styleData) {
        const startTime = Date.now();
        const modelMapping = {
            'auto': 'stability-ai/sdxl',
            'photorealistic': 'stability-ai/sdxl',
            'digital-art': 'black-forest-labs/flux-pro',
            'oil-painting': 'stability-ai/sdxl',
            'anime': 'black-forest-labs/flux-pro',
            'comic-book': 'black-forest-labs/flux-pro',
            'fantasy-art': 'stability-ai/sdxl',
            'lorenzale-allegory-style': 'stability-ai/sdxl',
            'rackham-style': 'black-forest-labs/flux-pro',
            'wrightson-style': 'stability-ai/sdxl',
            'moebius-style': 'black-forest-labs/flux-pro',
            'frazetta-style': 'stability-ai/sdxl',
            'brom-style': 'stability-ai/sdxl',
            'giger-style': 'stability-ai/sdxl'
        };
        const model = modelMapping[styleData.name] || 'stability-ai/sdxl';
        try {
            const response = await fetch('https://openrouter.ai/api/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${appState.openrouterApiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'narrativAI'
                },
                body: JSON.stringify({
                    model: model,
                    prompt: prompt,
                    n: 1,
                    size: `${width}x${height}`,
                    response_format: 'url'
                })
            });
            if (!response.ok) throw new Error(`OpenRouter error ${response.status}`);
            const data = await response.json();
            if (data.data && data.data[0] && data.data[0].url) {
                return {
                    url: data.data[0].url,
                    prompt: prompt,
                    appliedStyle: styleData.name,
                    styleKeywords: styleData.keywords,
                    width: width,
                    height: height,
                    seed: seed,
                    api: `OpenRouter (${model})`,
                    isRealAI: true,
                    isPlaceholder: false,
                    loadTime: Date.now() - startTime,
                    generation: appState.currentGeneration
                };
            }
        } catch (error) {
            console.error('‚ùå OpenRouter fall√≥:', error);
            throw error;
        }
    }

    // ==================== GENERAR CON POLLINATIONS (¬°CORREGIDO!) ====================
    async function generateWithPollinations(prompt, width, height, seed, styleData) {
        const startTime = Date.now();
        const imageAPIs = [
            {
                name: 'Pollinations AI Flux Ultra',
                url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&model=flux&enhance=true&quality=high`,
                timeout: 35000
            },
            {
                name: 'Pollinations AI Standard Plus',
                url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=${width}&height=${height}&seed=${seed}&nologo=true&enhance=true`,
                timeout: 30000
            },
            {
                name: 'Pollinations AI Basic',
                url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt.substring(0, 300))}?seed=${seed}&nologo=true`,
                timeout: 25000
            },
            {
                name: 'Pollinations AI Simple',
                url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt.substring(0, 200))}?seed=${seed}`,
                timeout: 20000
            },
            {
                name: 'Pollinations AI Minimal',
                url: `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt.substring(0, 100))}`,
                timeout: 15000
            }
        ];

        for (let i = 0; i < imageAPIs.length; i++) {
            const api = imageAPIs[i];
            console.log(`üîÑ Intentando con: ${api.name}`);
            try {
                const result = await tryImageGeneration(api, prompt);
                if (result && result.isValid) {
                    return {
                        url: result.url,
                        prompt: prompt,
                        appliedStyle: styleData.name,
                        styleKeywords: styleData.keywords,
                        width: result.width || width,
                        height: result.height || height,
                        seed: seed,
                        api: api.name,
                        isRealAI: true,
                        isPlaceholder: false,
                        loadTime: result.loadTime,
                        generation: appState.currentGeneration
                    };
                }
            } catch (error) {
                console.warn(`‚ùå ${api.name} fall√≥:`, error.message);
            }
        }

        // Si todas fallan, usa placeholder
        console.warn('‚ö†Ô∏è Todas las APIs de Pollinations fallaron');
        return createErrorPlaceholder(prompt, width, height, seed, styleData, appState.currentGeneration);
    }

    // ==================== INTENTAR CARGA DE IMAGEN ====================
    async function tryImageGeneration(apiConfig, prompt) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            const timeoutId = setTimeout(() => reject(new Error(`Timeout: ${apiConfig.timeout}ms`)), apiConfig.timeout);
            const img = new Image();
            img.onload = function() {
                clearTimeout(timeoutId);
                const loadTime = Date.now() - startTime;
                if (this.naturalWidth > 50 && this.naturalHeight > 50) {
                    resolve({
                        url: apiConfig.url,
                        width: this.naturalWidth,
                        height: this.naturalHeight,
                        loadTime: loadTime,
                        isValid: true
                    });
                } else {
                    reject(new Error(`Imagen muy peque√±a: ${this.naturalWidth}x${this.naturalHeight}`));
                }
            };
            img.onerror = () => {
                clearTimeout(timeoutId);
                reject(new Error('Error de carga'));
            };
            img.src = apiConfig.url;
        });
    }

    // ==================== CREAR PLACEHOLDER DE ERROR ====================
    function createErrorPlaceholder(prompt, width, height, seed, styleData, generation) {
        const cleanPrompt = prompt.replace(/[<>&"']/g, '').substring(0, 40);
        const cleanStyleName = styleData.name.replace(/[<>&"']/g, '');
        const svgContent = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="errorGrad${seed}" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ef4444;stop-opacity:0.9" />
                    <stop offset="100%" style="stop-color:#dc2626;stop-opacity:0.9" />
                </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#errorGrad${seed})"/>
            <text x="50%" y="25%" text-anchor="middle" fill="white" font-size="48" font-family="Arial">‚ö†Ô∏è</text>
            <text x="50%" y="35%" text-anchor="middle" fill="white" font-size="20" font-family="Arial, sans-serif" font-weight="bold">APIs No Disponibles</text>
            <text x="50%" y="45%" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="14" font-family="Arial, sans-serif">Intenta "üîÑ Nueva Variaci√≥n"</text>
            <text x="50%" y="55%" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="12" font-family="Arial, sans-serif">Estilo: ${cleanStyleName}</text>
            <text x="50%" y="65%" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="12" font-family="Arial, sans-serif">Prompt: ${cleanPrompt}${cleanPrompt.length >= 40 ? '...' : ''}</text>
            <rect x="3" y="3" width="${width-6}" height="${height-6}" fill="none" stroke="#ffffff" stroke-width="2" rx="8" opacity="0.3" stroke-dasharray="10,5"/>
        </svg>`;
        try {
            const encodedSvg = btoa(unescape(encodeURIComponent(svgContent)));
            return {
                url: `image/svg+xml;base64,${encodedSvg}`,
                prompt: prompt,
                appliedStyle: styleData.name,
                width: width,
                height: height,
                seed: seed,
                api: 'Placeholder Error',
                isRealAI: false,
                isPlaceholder: true,
                error: 'APIs no disponibles',
                generation: generation
            };
        } catch (e) {
            return {
                url: `image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`,
                prompt: prompt,
                appliedStyle: styleData.name,
                width: width,
                height: height,
                seed: seed,
                api: 'Fallback Placeholder',
                isRealAI: false,
                isPlaceholder: true,
                error: 'Fallback',
                generation: generation
            };
        }
    }

    // ==================== GENERAR IMAGEN CON ESTILO ====================
    async function generateImageWithStyle(prompt) {
        const width = 1024;
        const height = 768;
        const seed = Math.floor(Math.random() * 1000000);
        appState.currentGeneration++;
        const artStyleSelect = document.getElementById('artStyle');
        const selectedStyle = artStyleSelect ? artStyleSelect.value : 'auto';
        const styleData = artisticStyles[selectedStyle] || artisticStyles['auto'];
        const cleanPrompt = prompt.replace(/[^\w\s,.!?-]/g, ' ').replace(/\s+/g, ' ').trim().substring(0, 500);
        let imageResult;

        if (appState.activeImageProvider === 'openrouter' && appState.openrouterApiKey) {
            try {
                imageResult = await generateWithOpenRouter(cleanPrompt, width, height, seed, styleData);
            } catch (error) {
                console.warn('‚ö†Ô∏è OpenRouter fall√≥, usando Pollinations:', error);
                showNotification('‚ö†Ô∏è OpenRouter fall√≥, usando Pollinations como fallback', 'yellow');
                imageResult = await generateWithPollinations(cleanPrompt, width, height, seed, styleData);
            }
        } else {
            imageResult = await generateWithPollinations(cleanPrompt, width, height, seed, styleData);
        }

        return imageResult;
    }

    // ==================== MANEJADORES DE EVENTOS ====================
    async function handleGenerateNarrative() {
        if (appState.isGenerating) return;
        const generateBtn = document.getElementById('generateBtn');
        const generateBtnText = document.getElementById('generateBtnText');
        const loadingNarrative = document.getElementById('loadingNarrative');
        const narrativePlaceholder = document.getElementById('narrativePlaceholder');
        const narrativeContent = document.getElementById('narrativeContent');
        try {
            appState.isGenerating = true;
            generateBtn.disabled = true;
            generateBtnText.textContent = 'üé≠ Tejiendo √©pica...';
            loadingNarrative.classList.remove('hidden');
            narrativePlaceholder.classList.add('hidden');
            narrativeContent.classList.add('hidden');
            const narrative = generateNarrative();
            appState.generatedNarrative = narrative;
            await new Promise(resolve => setTimeout(resolve, 2000));
            loadingNarrative.classList.add('hidden');
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            narrativeDisplay.innerHTML = narrative.replace(/\n/g, '<br><br>');
            narrativeContent.classList.remove('hidden');
            updateImageReadyState();
            showNotification('üé≠ ¬°Narrativa √©pica generada! Ahora puedes crear imagen', 'green');
        } catch (error) {
            console.error('Error:', error);
            showNotification(error.message, 'red');
            loadingNarrative.classList.add('hidden');
            narrativePlaceholder.classList.remove('hidden');
        } finally {
            appState.isGenerating = false;
            generateBtn.disabled = false;
            generateBtnText.textContent = 'üé≠ Generar Narrativa';
        }
    }

    async function handleGenerateImage() {
        if (!appState.generatedNarrative) {
            showNotification('‚ö†Ô∏è Genera una narrativa primero.', 'yellow');
            return;
        }
        if (appState.isGenerating) return;
        const generateImageBtn = document.getElementById('generateImageBtn');
        const generateImageBtnText = document.getElementById('generateImageBtnText');
        const loadingImage = document.getElementById('loadingImage');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        try {
            appState.isGenerating = true;
            generateImageBtn.disabled = true;
            generateImageBtnText.textContent = 'üé® Creando imagen...';
            imagePlaceholder.classList.add('hidden');
            loadingImage.classList.remove('hidden');
            const customElements = [
                document.getElementById('element1')?.value?.trim() || '',
                document.getElementById('element2')?.value?.trim() || '',
                document.getElementById('element3')?.value?.trim() || ''
            ].filter(Boolean);
            const imagePrompt = createImagePrompt(appState.generatedNarrative, customElements);
            const imageResult = await generateImageWithStyle(imagePrompt);
            loadingImage.classList.add('hidden');
            displayImage(imageResult);
            if (imageResult.isRealAI && !imageResult.isPlaceholder) {
                showNotification(`üéâ ¬°IMAGEN IA REAL! API: ${imageResult.api}`, 'green');
            } else if (imageResult.isPlaceholder) {
                showNotification('‚ö†Ô∏è APIs no disponibles - Intenta "üîÑ Nueva Variaci√≥n"', 'yellow');
            } else {
                showNotification('‚úÖ Imagen creada', 'green');
            }
        } catch (error) {
            console.error('Error:', error);
            loadingImage.classList.add('hidden');
            imagePlaceholder.classList.remove('hidden');
            showNotification('‚ùå Error t√©cnico - Intenta de nuevo', 'red');
        } finally {
            appState.isGenerating = false;
            generateImageBtn.disabled = false;
            generateImageBtnText.textContent = 'üé® Generar Imagen IA';
        }
    }

    // ==================== GESTI√ìN DE GALER√çA Y UI ====================
    function displayImage(imageResult) {
        if (!imageResult || !imageResult.url) return;
        const imageData = {
            ...imageResult,
            timestamp: Date.now(),
            id: `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
        };
        appState.imageHistory.push(imageData);
        const placeholder = document.getElementById('imagePlaceholder');
        const gallery = document.getElementById('imageGallery');
        const controls = document.getElementById('imageControls');
        const status = document.getElementById('imageStatus');
        placeholder.classList.add('hidden');
        gallery.classList.remove('hidden');
        controls.classList.remove('hidden');
        renderImageGallery();
        status.innerHTML = `<div class="text-sm">üé® Generaci√≥n #${imageResult.generation} - ${imageResult.api}</div>`;
        status.classList.remove('hidden');
    }

    function renderImageGallery() {
        const gallery = document.getElementById('imageGallery');
        if (!gallery || appState.imageHistory.length === 0) return;
        const latestImage = appState.imageHistory[appState.imageHistory.length - 1];
        let galleryHTML = `
            <div class="mb-4 p-4 bg-purple-900/20 rounded-lg border border-purple-500/30">
                <h4 class="text-sm font-medium text-purple-300 mb-2">üé® Tu Galer√≠a √âpica (${appState.imageHistory.length} im√°genes)</h4>
            </div>
            <div class="mb-6">
                <img src="${latestImage.url}" class="w-full h-64 object-cover rounded-lg border-2 border-purple-500 cursor-pointer" onclick="openImageModal('${latestImage.id}')">
            </div>`;
        gallery.innerHTML = galleryHTML;
    }

    function updateImageReadyState() {
        const placeholderMessage = document.getElementById('placeholderMessage');
        const readyMessage = document.getElementById('readyMessage');
        const generateImageBtn = document.getElementById('generateImageBtn');
        if (appState.generatedNarrative) {
            placeholderMessage.classList.add('hidden');
            readyMessage.classList.remove('hidden');
        }
        if (generateImageBtn) {
            generateImageBtn.disabled = !appState.generatedNarrative;
        }
    }

    // ==================== EDICI√ìN DE NARRATIVA ====================
    let isEditingNarrative = false;
    let originalNarrativeText = '';

    window.toggleNarrativeEdit = function() {
        const narrativeDisplay = document.getElementById('narrativeDisplay');
        const narrativeEditor = document.getElementById('narrativeEditor');
        const narrativeTextarea = document.getElementById('narrativeTextarea');
        const editBtn = document.getElementById('editNarrativeBtn');
        const saveBtn = document.getElementById('saveNarrativeBtn');
        const cancelBtn = document.getElementById('cancelNarrativeBtn');
        if (!isEditingNarrative) {
            isEditingNarrative = true;
            originalNarrativeText = appState.generatedNarrative;
            narrativeDisplay.classList.add('hidden');
            narrativeEditor.classList.remove('hidden');
            narrativeTextarea.value = appState.generatedNarrative;
            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');
            setTimeout(() => narrativeTextarea.focus(), 100);
            showNotification('‚úèÔ∏è Modo edici√≥n activado', 'blue');
        } else {
            cancelNarrativeEdit();
        }
    };

    window.saveNarrativeEdit = function() {
        const narrativeTextarea = document.getElementById('narrativeTextarea');
        const newText = narrativeTextarea.value.trim();
        if (newText === '') {
            showNotification('‚ö†Ô∏è No puede estar vac√≠a', 'yellow');
            return;
        }
        if (newText === originalNarrativeText) {
            showNotification('üí° No hay cambios', 'blue');
            cancelNarrativeEdit();
            return;
        }
        appState.generatedNarrative = newText;
        document.getElementById('narrativeDisplay').innerHTML = newText.replace(/\n/g, '<br><br>');
        exitEditMode();
        showNotification('üíæ Guardado', 'green');
    };

    window.cancelNarrativeEdit = function() {
        const narrativeTextarea = document.getElementById('narrativeTextarea');
        const currentText = narrativeTextarea.value.trim();
        if (currentText !== originalNarrativeText && currentText !== '') {
            if (!confirm('¬øCancelar? Se perder√°n los cambios.')) return;
        }
        exitEditMode();
        showNotification('‚ùå Cancelado', 'yellow');
    };

    function exitEditMode() {
        const narrativeDisplay = document.getElementById('narrativeDisplay');
        const narrativeEditor = document.getElementById('narrativeEditor');
        const editBtn = document.getElementById('editNarrativeBtn');
        const saveBtn = document.getElementById('saveNarrativeBtn');
        const cancelBtn = document.getElementById('cancelNarrativeBtn');
        isEditingNarrative = false;
        narrativeDisplay.classList.remove('hidden');
        narrativeEditor.classList.add('hidden');
        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
    }

    function updateCharCount() {
        const textarea = document.getElementById('narrativeTextarea');
        const count = document.getElementById('charCount');
        if (textarea && count) {
            const len = textarea.value.length;
            count.textContent = `${len} caracteres`;
            count.className = len < 100 ? 'text-red-400' : len < 500 ? 'text-yellow-400' : 'text-green-400';
        }
    }

    // ==================== FUNCIONES GLOBALES ====================
    window.regenerateImage = async function() {
        const btn = document.getElementById('generateImageBtn');
        btn.disabled = true;
        btn.textContent = 'üîÑ Regenerando...';
        await new Promise(resolve => setTimeout(resolve, 500));
        await handleGenerateImage();
        btn.disabled = false;
        btn.textContent = 'üé® Generar Imagen IA';
    };

    window.clearImageHistory = function() {
        if (confirm('¬øLimpiar toda la galer√≠a?')) {
            appState.imageHistory = [];
            document.getElementById('imageGallery').classList.add('hidden');
            document.getElementById('imagePlaceholder').classList.remove('hidden');
            document.getElementById('imageControls').classList.add('hidden');
            document.getElementById('imageStatus').classList.add('hidden');
            showNotification('üóëÔ∏è Galer√≠a limpiada', 'blue');
        }
    };

    window.openImageModal = function(imageId) {
        const imageData = appState.imageHistory.find(img => img.id === imageId);
        if (!imageData) return;
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        modal.onclick = () => document.body.removeChild(modal);
        modal.innerHTML = `
            <div class="max-w-4xl max-h-full bg-gray-800 rounded-lg overflow-hidden" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-gray-600">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-purple-400">Detalles de Imagen</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">√ó</button>
                    </div>
                </div>
                <div class="p-4">
                    <img src="${imageData.url}" alt="Imagen" class="w-full rounded-lg mb-4">
                    <div class="text-sm text-gray-300">
                        <p><strong>Generado:</strong> ${new Date(imageData.timestamp).toLocaleString('es-ES')}</p>
                        <p><strong>API:</strong> ${imageData.api}</p>
                        <p><strong>Prompt:</strong> ${imageData.prompt}</p>
                    </div>
                </div>
            </div>`;
        document.body.appendChild(modal);
    };

    window.removeImage = function(imageId) {
        if (confirm('¬øEliminar esta imagen?')) {
            appState.imageHistory = appState.imageHistory.filter(img => img.id !== imageId);
            if (appState.imageHistory.length === 0) {
                clearImageHistory();
            } else {
                renderImageGallery();
            }
            showNotification('üóëÔ∏è Eliminada', 'blue');
        }
    };

    window.downloadProject = async function() {
        if (!appState.generatedNarrative) {
            showNotification('‚ö†Ô∏è Genera narrativa primero.', 'yellow');
            return;
        }
        const btn = document.getElementById('downloadBtn');
        const originalText = btn.textContent;
        btn.textContent = 'üì¶ Creando ZIP...';
        btn.disabled = true;
        try {
            const zip = new JSZip();
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
            zip.file('narrativa.md', '# Tu Narrativa √âpica\n' + appState.generatedNarrative);
            if (appState.imageHistory.length > 0) {
                for (let i = 0; i < appState.imageHistory.length; i++) {
                    try {
                        const response = await fetch(appState.imageHistory[i].url, { mode: 'cors' });
                        if (response.ok) {
                            const blob = await response.blob();
                            zip.file(`imagen-${String(i + 1).padStart(2, '0')}.jpg`, blob);
                        }
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è Fall√≥ imagen ${i + 1}`);
                    }
                }
            }
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(zipBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `narrativAI-epica-${timestamp}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('üéâ ¬°Descargado!', 'green');
        } catch (e) {
            console.error('Error ZIP:', e);
            showNotification('‚ùå Error al crear ZIP', 'red');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    };

    // ==================== INICIALIZACI√ìN ====================
    function setupEventListeners() {
        const generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
            generateBtn.addEventListener('click', handleGenerateNarrative);
        }
        const generateImageBtn = document.getElementById('generateImageBtn');
        if (generateImageBtn) {
            generateImageBtn.addEventListener('click', handleGenerateImage);
            generateImageBtn.disabled = !appState.generatedNarrative;
        }
        const artStyleSelect = document.getElementById('artStyle');
        if (artStyleSelect) {
            artStyleSelect.addEventListener('change', function(e) {
                const style = artisticStyles[e.target.value] || artisticStyles['auto'];
                showNotification(`üé® Estilo: ${style.name}`, 'blue');
            });
        }
        setupNarrativeEditorListeners();
    }

    function setupNarrativeEditorListeners() {
        const textarea = document.getElementById('narrativeTextarea');
        if (textarea) {
            textarea.addEventListener('input', updateCharCount);
        }
    }

    function initializeApp() {
        console.log('üöÄ Inicializando narrativAI...');
        createGenreElements();
        updateGenreCount();
        setupEventListeners();
        setupApiConfiguration();
        updateImageReadyState();
        updateOpenrouterStatus(!!appState.openrouterApiKey);
        setTimeout(() => showNotification('üé≠ narrativAI listo!', 'purple'), 500);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
</script>
</body>
</html>
