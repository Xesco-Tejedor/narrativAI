<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ narrativAI - Tu Motor de Narrativas √âpicas Personalizadas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
        }
        .genre-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .genre-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }
        .genre-card:hover:not(.selected) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .genre-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .genre-card:hover::before {
            left: 100%;
        }
        .loading-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .progress-bar {
            background: linear-gradient(90deg, #8b5cf6, #ec4899, #f59e0b);
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            transition: opacity 0.3s, visibility 0.3s;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(31, 41, 55, 0.95);
        }
        .tooltip-trigger:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .style-preview {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            margin-right: 8px;
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
        .control-group {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            backdrop-filter: blur(10px);
        }
        .narrative-area {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(10px);
        }
        .image-gallery-item {
            transition: all 0.3s ease;
        }
        .image-gallery-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }
        .floating-help {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .hero-gradient {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1), rgba(245, 158, 11, 0.1));
        }
        .step-container {
            transition: all 0.5s ease;
            opacity: 0.6;
        }
        .step-container.active {
            opacity: 1;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="text-white">
    <!-- Hero Section -->
    <div class="hero-gradient py-8 mb-8">
        <div class="container mx-auto px-4 max-w-7xl">
            <div class="text-center">
                <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-yellow-500 bg-clip-text text-transparent mb-4">
                    üé≠ narrativAI
                </h1>
                <p class="text-xl md:text-2xl text-gray-300 mb-2">
                    Tu Motor de Narrativas √âpicas Personalizadas
                </p>
                <p class="text-lg text-purple-300 mb-6">
                    ‚ú® Crea historias √∫nicas con elementos personalizados + Im√°genes IA reales
                </p>
                
                <!-- Progress Indicator -->
                <div class="max-w-2xl mx-auto">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div id="step1-indicator" class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-purple-500">1</div>
                            <span class="text-sm text-gray-300">Elementos</span>
                        </div>
                        <div class="flex-1 h-1 bg-gray-700 mx-4 rounded">
                            <div id="progress-bar" class="progress-bar w-0"></div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div id="step2-indicator" class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-gray-600">2</div>
                            <span class="text-sm text-gray-300">G√©neros</span>
                        </div>
                        <div class="flex-1 h-1 bg-gray-700 mx-4 rounded">
                            <div class="h-1 bg-gray-700 rounded"></div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div id="step3-indicator" class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-gray-600">3</div>
                            <span class="text-sm text-gray-300">Generar</span>
                        </div>
                        <div class="flex-1 h-1 bg-gray-700 mx-4 rounded">
                            <div class="h-1 bg-gray-700 rounded"></div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div id="step4-indicator" class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-gray-600">4</div>
                            <span class="text-sm text-gray-300">Exportar</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Paso 1: Elementos Clave -->
        <div id="step1-container" class="step-container active mb-8">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">1</div>
                    <div>
                        <h2 class="text-2xl font-bold text-purple-400">Define Tus Elementos Clave</h2>
                        <p class="text-gray-300">Introduce hasta tres elementos que formar√°n el coraz√≥n de tu narrativa</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="tooltip-trigger relative">
                        <label class="block text-sm font-medium text-purple-300 mb-2">
                            üéØ Personaje o Elemento Central
                        </label>
                        <input type="text" id="element1" placeholder="ej: un valiente caballero, el √∫ltimo drag√≥n..." 
                               class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all"
                               oninput="updateProgress()">
                        <div class="tooltip">
                            ¬øQui√©n o qu√© ser√° el protagonista? Ejemplos: "un antiguo medall√≥n", "la √∫ltima bibliotecaria", "un drag√≥n mec√°nico"
                        </div>
                    </div>
                    
                    <div class="tooltip-trigger relative">
                        <label class="block text-sm font-medium text-purple-300 mb-2">
                            üî∏ Entorno o Elemento de Apoyo
                        </label>
                        <input type="text" id="element2" placeholder="ej: una biblioteca perdida, un sabio ermita√±o..." 
                               class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all"
                               oninput="updateProgress()">
                        <div class="tooltip">
                            ¬øD√≥nde ocurre la acci√≥n o qu√© elemento secundario influye? Ejemplos: "un mapa estelar", "ruinas flotantes", "un or√°culo misterioso"
                        </div>
                    </div>
                    
                    <div class="tooltip-trigger relative">
                        <label class="block text-sm font-medium text-purple-300 mb-2">
                            üèõÔ∏è Atm√≥sfera o Concepto
                        </label>
                        <input type="text" id="element3" placeholder="ej: un futuro dist√≥pico, un ritual olvidado..." 
                               class="w-full p-4 bg-gray-700/70 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30 text-white transition-all"
                               oninput="updateProgress()">
                        <div class="tooltip">
                            ¬øQu√© atm√≥sfera o concepto impregna tu historia? Ejemplos: "la era vikinga", "magia prohibida", "realidades paralelas"
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                    <p class="text-sm text-blue-300">
                        üí° <strong>Consejo:</strong> No te preocupes por el orden. Nuestros algoritmos integrar√°n estos elementos de forma inteligente en tu narrativa √©pica.
                    </p>
                </div>
            </div>
        </div>

        <!-- Paso 2: G√©neros -->
        <div id="step2-container" class="step-container mb-8">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-yellow-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">2</div>
                    <div>
                        <h2 class="text-2xl font-bold text-pink-400">Equilibra los G√©neros de Tu Historia</h2>
                        <p class="text-gray-300">Elige hasta tres g√©neros y ajusta su influencia con nuestros deslizadores inteligentes</p>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-purple-400">
                        üé≠ Selecciona g√©neros (m√°ximo 3)
                    </h3>
                    <span id="genreCount" class="text-sm bg-gradient-to-r from-purple-600 to-pink-600 px-3 py-1 rounded-full font-medium">0/3</span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="genreGrid">
                    <!-- G√©neros se generan din√°micamente -->
                </div>

                <!-- Controles de intensidad de g√©neros -->
                <div id="genreIntensityControls" class="hidden">
                    <div class="bg-gray-900/50 rounded-xl p-6 border border-purple-500/30">
                        <h4 class="text-lg font-medium text-purple-300 mb-4 flex items-center">
                            ‚öñÔ∏è Control de Intensidad Din√°mico
                            <div class="ml-4 text-sm bg-green-600 px-2 py-1 rounded-full" id="totalDisplay">100%</div>
                        </h4>
                        <div id="genreSliders" class="space-y-4">
                            <!-- Sliders se generan din√°micamente -->
                        </div>
                        <div class="text-sm text-gray-400 mt-4 p-3 bg-purple-900/20 rounded-lg border border-purple-500/20">
                            ‚öñÔ∏è <strong>Auto-balance inteligente:</strong> Al ajustar un g√©nero, los otros se rebalancean autom√°ticamente para mantener siempre el 100%. ¬°Observa la magia en tiempo real!
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                    <p class="text-sm text-yellow-300">
                        ‚ú® <strong>Consejo:</strong> Si ya tienes 3 g√©neros seleccionados, deselecciona uno primero para elegir uno nuevo. El sistema te avisar√° autom√°ticamente.
                    </p>
                </div>
            </div>
        </div>

        <!-- Paso 3: Generar y Imagen IA -->
        <div id="step3-container" class="step-container mb-8">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Narrativa -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-yellow-500 to-green-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">3</div>
                            <div>
                                <h2 class="text-2xl font-bold text-yellow-400">Genera y Perfecciona</h2>
                                <p class="text-gray-300">Crea tu narrativa √©pica estructurada</p>
                            </div>
                        </div>
                        <button id="generateBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <span id="generateBtnText">üé≠ Generar Narrativa</span>
                        </button>
                    </div>
                    
                    <div id="narrativePlaceholder" class="text-center text-gray-400 py-12 border-2 border-dashed border-gray-600 rounded-lg">
                        <div class="text-4xl mb-3">üìö</div>
                        <p class="text-lg">¬°Completa los elementos y g√©neros para comenzar!</p>
                        <p class="text-sm mt-2 opacity-75">Tu narrativa √©pica de 4 p√°rrafos aparecer√° aqu√≠</p>
                    </div>
                    
                    <div id="narrativeContent" class="hidden">
                        <div class="narrative-area rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm text-purple-300 font-medium">üìù Tu Narrativa √âpica (editable)</span>
                                <div class="flex gap-2">
                                    <button id="editNarrativeBtn" onclick="toggleNarrativeEdit()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg text-xs transition-colors">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button id="saveNarrativeBtn" onclick="saveNarrativeEdit()" class="hidden px-3 py-1 bg-green-600 hover:bg-green-700 rounded-lg text-xs transition-colors">
                                        ‚úÖ Guardar
                                    </button>
                                    <button id="cancelNarrativeBtn" onclick="cancelNarrativeEdit()" class="hidden px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded-lg text-xs transition-colors">
                                        ‚ùå Cancelar
                                    </button>
                                </div>
                            </div>
                            <div id="narrativeDisplay" class="text-gray-100 leading-relaxed text-lg"></div>
                            <textarea id="narrativeEditor" class="hidden w-full h-40 p-4 bg-gray-800/70 border border-gray-600 rounded-lg text-gray-100 leading-relaxed resize-vertical focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/30" placeholder="Edita tu narrativa aqu√≠..."></textarea>
                        </div>
                        
                        <div class="mt-4 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                            <p class="text-sm text-green-300">
                                ‚úÖ <strong>Estructura Garantizada:</strong> Establecimiento ‚Üí Desarrollo ‚Üí Cl√≠max ‚Üí Resoluci√≥n. ¬°Tu historia sigue una estructura √©pica probada!
                            </p>
                        </div>
                    </div>
                    
                    <div id="loadingNarrative" class="hidden text-center py-8">
                        <div class="loading-animation text-4xl mb-3">üé≠</div>
                        <p class="text-purple-300 text-lg">Tejiendo tu narrativa √©pica...</p>
                        <div class="mt-4 w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                        </div>
                    </div>
                </div>

                <!-- Im√°genes IA -->
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-purple-400">üé® Im√°genes √âpicas con IA</h3>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="useImageAI" class="w-5 h-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                            <label for="useImageAI" class="text-sm font-medium text-purple-300">
                                Activar Generaci√≥n IA
                            </label>
                        </div>
                    </div>
                    
                    <div id="imageAIInfo" class="hidden mb-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                        <p class="text-sm text-blue-300">
                            üé® <strong>Magia Visual:</strong> Tu narrativa se analizar√° autom√°ticamente para crear im√°genes √∫nicas que capturan la esencia de tu historia.
                        </p>
                    </div>

                    <!-- Selector de Estilo Art√≠stico -->
                    <div id="artStyleSection" class="hidden mb-4">
                        <label class="block text-sm font-medium text-purple-300 mb-3">
                            üé® Elige tu Estilo Art√≠stico
                        </label>
                        <select id="artStyle" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500">
                            <option value="auto">ü§ñ Autom√°tico (basado en tu narrativa)</option>
                            <option value="rackham-style">üßö Arthur Rackham - Fantas√≠a detallada con acuarelas</option>
                            <option value="wrightson-style">üíÄ Bernie Wrightson - Horror sombr√≠o con tinta</option>
                            <option value="moebius-style">üåå Moebius - Ciencia ficci√≥n et√©rea</option>
                            <option value="frazetta-style">‚öîÔ∏è Frank Frazetta - Fantas√≠a heroica √©pica</option>
                            <option value="brom-style">üåô Gerald Brom - Fantas√≠a oscura g√≥tica</option>
                            <option value="giger-style">üëæ H.R. Giger - Horror biomec√°nico</option>
                            <option value="photorealistic">üì∏ Fotorrealista - M√°ximo realismo</option>
                            <option value="digital-art">üñ•Ô∏è Arte Digital - Ilustraci√≥n moderna</option>
                            <option value="oil-painting">üé® Pintura al √ìleo - Arte cl√°sico</option>
                            <option value="anime">üáØüáµ Anime/Manga - Estilo japon√©s</option>
                            <option value="comic-book">üìö C√≥mic - Colores vibrantes din√°micos</option>
                            <option value="fantasy-art">üßô‚Äç‚ôÇÔ∏è Arte Fant√°stico - Realismo m√°gico</option>
                        </select>
                    </div>

                    <!-- Nivel de Detalle -->
                    <div id="detailSection" class="hidden mb-4">
                        <label class="block text-sm font-medium text-purple-300 mb-3">
                            üîç Nivel de Detalle
                        </label>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="setDetailLevel('low')" class="detail-btn px-3 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg text-xs transition-colors">
                                Boceto
                            </button>
                            <button onclick="setDetailLevel('medium')" class="detail-btn active px-3 py-2 bg-purple-600 rounded-lg text-xs">
                                Detallado
                            </button>
                            <button onclick="setDetailLevel('high')" class="detail-btn px-3 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg text-xs transition-colors">
                                Intrincado
                            </button>
                            <button onclick="setDetailLevel('ultra')" class="detail-btn px-3 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg text-xs transition-colors">
                                Obra Maestra
                            </button>
                        </div>
                    </div>
                    
                    <div id="imagePlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                        <div class="text-3xl mb-2">üé®</div>
                        <div id="placeholderMessage">
                            <p class="text-sm">Activa la generaci√≥n IA y crea una narrativa</p>
                            <p class="text-xs mt-1 opacity-75">‚ú® Las im√°genes se generar√°n autom√°ticamente</p>
                        </div>
                        <div id="readyMessage" class="hidden">
                            <p class="text-sm text-green-300">‚úÖ ¬°Todo listo! Genera tu narrativa</p>
                            <p class="text-xs mt-1 opacity-75">üé≠ Una imagen √©pica aparecer√° autom√°ticamente</p>
                        </div>
                    </div>
                    
                    <div id="loadingImage" class="hidden text-center py-8 border-2 border-dashed border-purple-500 rounded-lg">
                        <div class="loading-animation text-3xl mb-2">üé®</div>
                        <p class="text-purple-300 text-sm">Creando tu imagen √©pica...</p>
                        <p class="text-xs text-purple-400 mt-1">Analizando narrativa y aplicando estilo art√≠stico</p>
                        <div class="mt-4 w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full animate-pulse" style="width: 80%"></div>
                        </div>
                    </div>
                    
                    <!-- Galer√≠a de im√°genes -->
                    <div id="imageGallery" class="hidden space-y-4">
                        <!-- Las im√°genes se a√±adir√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <div id="imageStatus" class="mt-3 p-3 bg-green-900/30 rounded-lg border border-green-500/50 text-sm text-green-300 hidden">
                        <!-- Status se actualiza din√°micamente -->
                    </div>

                    <!-- Controles de imagen -->
                    <div id="imageControls" class="hidden mt-4 flex flex-wrap gap-2">
                        <button onclick="regenerateImage()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition-colors">
                            üîÑ Nueva Variaci√≥n
                        </button>
                        <button onclick="clearImageHistory()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">
                            üóëÔ∏è Limpiar Galer√≠a
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 4: Exportar -->
        <div id="step4-container" class="step-container mb-8">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center text-xl font-bold mr-4">4</div>
                        <div>
                            <h2 class="text-2xl font-bold text-green-400">Exporta Tu Proyecto Completo</h2>
                            <p class="text-gray-300">Descarga todo tu trabajo en un c√≥modo paquete ZIP</p>
                        </div>
                    </div>
                    <button onclick="downloadCompleteProject()" id="downloadBtn" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-lg disabled:opacity-50">
                        üì¶ Descargar Proyecto
                    </button>
                </div>
                
                <div id="exportPlaceholder" class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-600 rounded-lg">
                    <div class="text-4xl mb-3">üì¶</div>
                    <p class="text-lg">Genera tu narrativa para activar la exportaci√≥n</p>
                    <p class="text-sm mt-2 opacity-75">Recibir√°s un ZIP completo con historia, im√°genes y metadatos</p>
                </div>
                
                <div id="exportReady" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                            <div class="text-blue-400 text-xl mb-2">üìÑ</div>
                            <h4 class="font-semibold text-blue-300">narrativa.md</h4>
                            <p class="text-xs text-gray-400">Historia completa con metadatos</p>
                        </div>
                        <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                            <div class="text-purple-400 text-xl mb-2">üñºÔ∏è</div>
                            <h4 class="font-semibold text-purple-300">im√°genes.jpg</h4>
                            <p class="text-xs text-gray-400">Todas tus im√°genes optimizadas</p>
                        </div>
                        <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                            <div class="text-green-400 text-xl mb-2">üìã</div>
                            <h4 class="font-semibold text-green-300">README.txt</h4>
                            <p class="text-xs text-gray-400">Informaci√≥n t√©cnica del proyecto</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                        <p class="text-sm text-green-300">
                            üéâ <strong>¬°Tu leyenda est√° lista!</strong> Tu proyecto est√° completo y listo para ser compartido, editado o utilizado en cualquier otro proyecto.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ayuda Flotante -->
    <div class="floating-help">
        <button onclick="toggleHelp()" class="bg-purple-600 hover:bg-purple-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all transform hover:scale-110">
            ?
        </button>
    </div>

    <!-- Modal de Ayuda -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="max-w-2xl bg-gray-800 rounded-lg overflow-hidden">
            <div class="p-6 border-b border-gray-600">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-purple-400">üé≠ Gu√≠a R√°pida - narrativAI</h3>
                    <button onclick="toggleHelp()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-sm font-bold">1</div>
                    <div>
                        <h4 class="font-semibold text-purple-300">Define Elementos</h4>
                        <p class="text-sm text-gray-400">Ingresa hasta 3 elementos que dar√°n vida a tu historia</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-pink-500 rounded-full flex items-center justify-center text-sm font-bold">2</div>
                    <div>
                        <h4 class="font-semibold text-pink-300">Equilibra G√©neros</h4>
                        <p class="text-sm text-gray-400">Selecciona hasta 3 g√©neros y ajusta su influencia</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-sm font-bold">3</div>
                    <div>
                        <h4 class="font-semibold text-yellow-300">Genera y Perfecciona</h4>
                        <p class="text-sm text-gray-400">Crea tu narrativa e im√°genes IA opcionales</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-sm font-bold">4</div>
                    <div>
                        <h4 class="font-semibold text-green-300">Exporta Proyecto</h4>
                        <p class="text-sm text-gray-400">Descarga todo en un ZIP completo y organizado</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let appState = {
            selectedGenres: [],
            genreIntensities: {},
            generatedNarrative: '',
            useImageAI: false,
            currentImageUrl: '',
            currentImagePrompt: '',
            currentDisplayPrompt: '',
            isGenerating: false,
            imageHistory: [],
            currentPromptHash: null,
            currentStep: 1,
            detailLevel: 'medium'
        };

        // G√©neros disponibles
        const genres = {
            'terror': { name: 'Terror', icon: 'üëª', color: 'from-red-600 to-red-800' },
            'fantasia': { name: 'Fantas√≠a', icon: 'üßô‚Äç‚ôÇÔ∏è', color: 'from-purple-600 to-purple-800' },
            'romance': { name: 'Romance', icon: 'üíï', color: 'from-pink-600 to-pink-800' },
            'misterio': { name: 'Misterio', icon: 'üîç', color: 'from-yellow-600 to-yellow-800' },
            'ciencia-ficcion': { name: 'Ciencia Ficci√≥n', icon: 'üöÄ', color: 'from-blue-600 to-blue-800' },
            'aventura': { name: 'Aventura', icon: '‚öîÔ∏è', color: 'from-green-600 to-green-800' },
            'comedia': { name: 'Comedia', icon: 'üòÑ', color: 'from-orange-600 to-orange-800' },
            'drama': { name: 'Drama', icon: 'üé≠', color: 'from-indigo-600 to-indigo-800' }
        };

        // Variables para edici√≥n
        let originalNarrativeText = '';
        let isEditingNarrative = false;

        // Funci√≥n auxiliar para mostrar notificaciones de forma consistente
        function showNotification(message, type) {
            const colors = {
                'green': 'bg-green-600',
                'yellow': 'bg-yellow-600', 
                'red': 'bg-red-600',
                'blue': 'bg-blue-600',
                'purple': 'bg-purple-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type] || 'bg-gray-600'} text-white px-4 py-2 rounded-lg z-50 max-w-sm shadow-lg`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove con verificaci√≥n de existencia
            setTimeout(() => {
                try {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                } catch (error) {
                    console.warn('Error removiendo notificaci√≥n:', error);
                }
            }, type === 'red' ? 6000 : 3000);
        }

        // Actualizar progreso y pasos
        function updateProgress() {
            const element1 = document.getElementById('element1').value.trim();
            const element2 = document.getElementById('element2').value.trim();
            const element3 = document.getElementById('element3').value.trim();
            
            const hasElements = element1 || element2 || element3;
            const hasGenres = appState.selectedGenres.length > 0;
            const hasNarrative = appState.generatedNarrative !== '';
            
            // Actualizar indicadores de paso
            updateStepIndicator(1, hasElements);
            updateStepIndicator(2, hasGenres);
            updateStepIndicator(3, hasNarrative);
            updateStepIndicator(4, hasNarrative);
            
            // Actualizar contenedores de paso
            updateStepContainers(hasElements, hasGenres, hasNarrative);
            
            // Actualizar barra de progreso
            let progress = 0;
            if (hasElements) progress += 25;
            if (hasGenres) progress += 25;
            if (hasNarrative) progress += 50;
            
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function updateStepIndicator(step, completed) {
            const indicator = document.getElementById(`step${step}-indicator`);
            if (completed) {
                indicator.className = 'step-indicator completed w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-green-500';
            } else if (step === appState.currentStep) {
                indicator.className = 'step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-purple-500';
            } else {
                indicator.className = 'step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 border-gray-600';
            }
        }

        function updateStepContainers(hasElements, hasGenres, hasNarrative) {
            // Paso 1 siempre activo
            document.getElementById('step1-container').className = 'step-container active mb-8';
            
            // Paso 2 activo si hay elementos
            const step2 = document.getElementById('step2-container');
            step2.className = hasElements ? 'step-container active mb-8' : 'step-container mb-8';
            
            // Paso 3 activo si hay elementos y g√©neros
            const step3 = document.getElementById('step3-container');
            step3.className = (hasElements && hasGenres) ? 'step-container active mb-8' : 'step-container mb-8';
            
            // Paso 4 activo si hay narrativa
            const step4 = document.getElementById('step4-container');
            step4.className = hasNarrative ? 'step-container active mb-8' : 'step-container mb-8';
            
            // Actualizar placeholders de exportaci√≥n
            if (hasNarrative) {
                document.getElementById('exportPlaceholder').classList.add('hidden');
                document.getElementById('exportReady').classList.remove('hidden');
            } else {
                document.getElementById('exportPlaceholder').classList.remove('hidden');
                document.getElementById('exportReady').classList.add('hidden');
            }
        }

        // Crear elementos de g√©nero
        function createGenreElements() {
            const genreGrid = document.getElementById('genreGrid');
            
            Object.keys(genres).forEach(genreId => {
                const genre = genres[genreId];
                const genreCard = document.createElement('div');
                genreCard.className = `genre-card bg-gradient-to-br ${genre.color} p-4 rounded-lg cursor-pointer text-center`;
                genreCard.dataset.genreId = genreId;
                
                genreCard.innerHTML = `
                    <div class="text-3xl mb-2">${genre.icon}</div>
                    <div class="text-sm font-medium">${genre.name}</div>
                `;
                
                genreCard.addEventListener('click', () => toggleGenre(genreId));
                genreGrid.appendChild(genreCard);
            });
        }

        // Alternar selecci√≥n de g√©nero
        function toggleGenre(genreId) {
            const genreCard = document.querySelector(`[data-genre-id="${genreId}"]`);
            const isSelected = appState.selectedGenres.includes(genreId);
            
            if (isSelected) {
                appState.selectedGenres = appState.selectedGenres.filter(g => g !== genreId);
                genreCard.classList.remove('selected');
                delete appState.genreIntensities[genreId];
            } else {
                if (appState.selectedGenres.length < 3) {
                    appState.selectedGenres.push(genreId);
                    genreCard.classList.add('selected');
                    appState.genreIntensities[genreId] = 70;
                } else {
                    showNotification('‚ö†Ô∏è Ya tienes 3 g√©neros. Deselecciona uno primero.', 'yellow');
                    return;
                }
            }
            
            updateGenreCount();
            updateGenreIntensityControls();
            updateProgress();
        }

        // Actualizar controles de intensidad de g√©neros
        function updateGenreIntensityControls() {
            const controlsSection = document.getElementById('genreIntensityControls');
            const slidersContainer = document.getElementById('genreSliders');
            
            if (appState.selectedGenres.length === 0) {
                controlsSection.classList.add('hidden');
                return;
            }
            
            controlsSection.classList.remove('hidden');
            slidersContainer.innerHTML = '';
            
            // Inicializar intensidades para que sumen 100
            initializeIntensitiesTo100();
            
            appState.selectedGenres.forEach(genreId => {
                const genre = genres[genreId];
                const intensity = appState.genreIntensities[genreId] || Math.floor(100 / appState.selectedGenres.length);
                
                const sliderHtml = `
                    <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${genre.icon}</span>
                                <span class="font-medium text-gray-200">${genre.name}</span>
                            </div>
                            <span id="intensity-value-${genreId}" class="text-sm font-bold text-purple-300 bg-purple-900/30 px-2 py-1 rounded">
                                ${intensity}%
                            </span>
                        </div>
                        <input type="range" 
                               id="intensity-${genreId}" 
                               min="1" 
                               max="98" 
                               value="${intensity}"
                               class="w-full accent-purple-500 h-2 rounded-lg appearance-none bg-gray-700"
                               oninput="updateGenreIntensity('${genreId}', this.value)">
                    </div>
                `;
                
                slidersContainer.innerHTML += sliderHtml;
            });
            
            updateTotalIndicator();
        }
        
        // Inicializar intensidades para que sumen exactamente 100
        function initializeIntensitiesTo100() {
            const numGenres = appState.selectedGenres.length;
            if (numGenres === 0) return;
            
            const baseValue = Math.floor(100 / numGenres);
            const remainder = 100 - (baseValue * numGenres);
            
            appState.selectedGenres.forEach((genreId, index) => {
                appState.genreIntensities[genreId] = baseValue + (index < remainder ? 1 : 0);
            });
        }
        
        // Actualizar indicador de total
        function updateTotalIndicator() {
            const total = appState.selectedGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
            const totalDisplay = document.getElementById('totalDisplay');
            
            if (totalDisplay) {
                totalDisplay.textContent = `${total}%`;
                totalDisplay.className = total === 100 ? 
                    'ml-4 text-sm bg-green-600 px-2 py-1 rounded-full' : 
                    'ml-4 text-sm bg-yellow-600 px-2 py-1 rounded-full';
            }
        }

        // Actualizar intensidad de g√©nero espec√≠fico manteniendo suma = 100
        window.updateGenreIntensity = function(genreId, value) {
            const newValue = parseInt(value);
            appState.genreIntensities[genreId] = newValue;
            
            const otherGenres = appState.selectedGenres.filter(id => id !== genreId);
            
            if (otherGenres.length > 0) {
                let otherTotal = otherGenres.reduce((sum, id) => sum + (appState.genreIntensities[id] || 0), 0);
                const targetOtherTotal = 100 - newValue;
                
                if (targetOtherTotal > 0 && otherTotal > 0) {
                    const ratio = targetOtherTotal / otherTotal;
                    
                    otherGenres.forEach(id => {
                        const currentValue = appState.genreIntensities[id] || 0;
                        const adjustedValue = Math.max(1, Math.round(currentValue * ratio));
                        appState.genreIntensities[id] = adjustedValue;
                        
                        const slider = document.getElementById(`intensity-${id}`);
                        const valueSpan = document.getElementById(`intensity-value-${id}`);
                        if (slider) slider.value = adjustedValue;
                        if (valueSpan) valueSpan.textContent = `${adjustedValue}%`;
                    });
                }
            }
            
            const valueSpan = document.getElementById(`intensity-value-${genreId}`);
            if (valueSpan) {
                valueSpan.textContent = `${newValue}%`;
            }
            
            updateTotalIndicator();
        };

        // Actualizar contador de g√©neros
        function updateGenreCount() {
            const genreCount = document.getElementById('genreCount');
            genreCount.textContent = `${appState.selectedGenres.length}/3`;
        }

        // Generar narrativa √©pica con intensidades
        function generateNarrative() {
            const element1 = document.getElementById('element1').value.trim();
            const element2 = document.getElementById('element2').value.trim();
            const element3 = document.getElementById('element3').value.trim();
            
            if (!element1 && !element2 && !element3) {
                throw new Error('üéØ Ingresa al menos un elemento personalizado para comenzar tu √©pica.');
            }
            
            if (appState.selectedGenres.length === 0) {
                throw new Error('üé≠ Selecciona al menos un g√©nero para dar forma a tu historia.');
            }
            
            const elements = [element1, element2, element3].filter(Boolean);
            const genreNames = appState.selectedGenres.map(id => genres[id].name);
            
            const dominantGenres = appState.selectedGenres
                .map(id => ({
                    id,
                    name: genreNames[appState.selectedGenres.indexOf(id)],
                    intensity: appState.genreIntensities[id] || 70
                }))
                .sort((a, b) => b.intensity - a.intensity);

            let narrativeStyle = '';
            if (dominantGenres[0]?.intensity > 85) {
                narrativeStyle = `Con una fuerte influencia de ${dominantGenres[0].name.toLowerCase()}, `;
            } else if (dominantGenres.length > 1 && dominantGenres[0]?.intensity > 70) {
                narrativeStyle = `Balanceando elementos de ${dominantGenres.map(g => g.name.toLowerCase()).join(' y ')}, `;
            }

            const narratives = [
                `${narrativeStyle}en las profundidades de ${element2 || 'un lugar misterioso'}, donde ${element3 || 'objetos antiguos'} guardan secretos milenarios, ${element1 || 'nuestro protagonista'} descubre que su destino est√° entrelazado con fuerzas m√°s all√° de su comprensi√≥n.`,

                `${narrativeStyle}cuando ${element1 || 'el protagonista'} se encuentra frente a ${element2 || 'lo desconocido'}, la presencia de ${element3 || 'elementos m√≠sticos'} revela verdades que cambiar√°n el curso de esta historia donde ${genreNames.join(' y ').toLowerCase()} se entrelazan.`,

                `Los elementos se entrelazan en una danza c√≥smica: ${elements.join(', ')} se convierten en las piezas fundamentales de una narrativa que ${narrativeStyle}trasciende los g√©neros de ${genreNames.join(', ')}, creando algo completamente nuevo y extraordinario.`,

                `En este universo donde ${genreNames.map(name => name.toLowerCase()).join(' se fusiona con ')} en perfecta armon√≠a, ${narrativeStyle}cada elemento cobra vida propia. ${element1 || 'El protagonista'} debe navegar entre ${element2 || 'm√∫ltiples realidades'} mientras ${element3 || 'fuerzas ancestrales'} despiertan para revelar los secretos m√°s profundos de la existencia.`
            ];
            
            return narratives.join('\n\n');
        }

        // Traducir texto al ingl√©s de forma simple pero efectiva
        function translateToEnglish(text) {
            if (!text) return text;
            
            const translations = {
                // B√°sicos
                'y': 'and', 'o': 'or', 'en': 'in', 'el': 'the', 'la': 'the', 'los': 'the', 'las': 'the',
                'un': 'a', 'una': 'a', 'de': 'of', 'del': 'of the', 'al': 'to the', 'con': 'with',
                
                // Narrativa
                'historia': 'story', 'narrativa': 'narrative', 'aventura': 'adventure', 'cuento': 'tale',
                'protagonista': 'protagonist', 'personaje': 'character', 'h√©roe': 'hero', 'hero√≠na': 'heroine',
                
                // Lugares
                'castillo': 'castle', 'biblioteca': 'library', 'bosque': 'forest', 'monta√±a': 'mountain',
                'oc√©ano': 'ocean', 'templo': 'temple', 'cueva': 'cave', 'torre': 'tower',
                
                // Objetos
                'libro': 'book', 'espada': 'sword', 'cristal': 'crystal', 'drag√≥n': 'dragon',
                'mago': 'wizard', 'hada': 'fairy', 'magia': 'magic',
                
                // Frases espec√≠ficas
                'pececillo de plata': 'silverfish creature',
                'biblioteca gigantesca': 'gigantic library',
                'fuerzas ancestrales': 'ancestral forces',
                'elementos m√≠sticos': 'mystical elements'
            };
            
            let translatedText = text.toLowerCase();
            
            // Procesar frases complejas primero
            Object.keys(translations).forEach(spanish => {
                if (spanish.includes(' ')) {
                    const regex = new RegExp('\\b' + spanish.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    translatedText = translatedText.replace(regex, translations[spanish]);
                }
            });
            
            // Luego procesar palabras individuales
            Object.keys(translations).forEach(spanish => {
                if (!spanish.includes(' ')) {
                    const regex = new RegExp('\\b' + spanish.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    translatedText = translatedText.replace(regex, translations[spanish]);
                }
            });
            
            return translatedText.replace(/\s+/g, ' ').trim();
        }

        // Crear prompt para imagen IA
        function createImagePrompt(narrative, customElements) {
            const englishNarrative = translateToEnglish(narrative);
            
            let promptParts = [];
            
            // Traducir autom√°ticamente todos los elementos personalizados
            if (customElements.length > 0) {
                customElements.forEach((element, index) => {
                    const translatedElement = translateToEnglish(element);
                    if (index === 0) {
                        promptParts.push(`${translatedElement} as main character`);
                    } else {
                        promptParts.push(`${translatedElement} in scene`);
                    }
                });
            }
            
            // Analizar narrativa para mood
            let mood = 'epic';
            const lowerText = englishNarrative.toLowerCase();
            if (lowerText.includes('dark') || lowerText.includes('shadow')) mood = 'dark and mysterious';
            else if (lowerText.includes('magic') || lowerText.includes('mystical')) mood = 'magical and enchanting';
            else if (lowerText.includes('romantic') || lowerText.includes('love')) mood = 'romantic and warm';
            
            promptParts.push(`${mood} atmosphere`);
            
            // Aplicar estilo art√≠stico
            const artStyle = document.getElementById('artStyle').value;
            const stylePrompts = {
                'rackham-style': 'Arthur Rackham style, intricate pen and ink, watercolor washes, fairy tale illustration',
                'wrightson-style': 'Bernie Wrightson style, detailed ink work, horror atmosphere, crosshatching',
                'moebius-style': 'Moebius style, clean lines, sci-fi, detailed backgrounds',
                'photorealistic': 'photorealistic, highly detailed, professional photography',
                'digital-art': 'digital art, concept art style, highly detailed illustration',
                'anime': 'anime style, manga art, vibrant colors'
            };
            
            if (artStyle !== 'auto' && stylePrompts[artStyle]) {
                promptParts.push(stylePrompts[artStyle]);
            }
            
            // Aplicar nivel de detalle
            const detailPrompts = {
                'low': 'simple, clean',
                'medium': 'detailed, well composed',
                'high': 'highly detailed, intricate',
                'ultra': 'ultra detailed, masterpiece quality, perfect composition'
            };
            
            promptParts.push(detailPrompts[appState.detailLevel]);
            promptParts.push('professional artwork, beautiful composition');
            
            return promptParts.join(', ');
        }

        // Funci√≥n auxiliar para cargar im√°genes de forma segura
        async function loadImageSafely(imageUrl, apiName) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const startTime = Date.now();
                
                // Configuraci√≥n para evitar problemas de CORS
                img.crossOrigin = 'anonymous';
                
                // Timeout robusto
                const timeout = setTimeout(() => {
                    img.onload = null;
                    img.onerror = null;
                    reject(new Error(`Timeout despu√©s de 12 segundos en ${apiName}`));
                }, 12000);
                
                img.onload = function() {
                    clearTimeout(timeout);
                    const loadTime = Date.now() - startTime;
                    
                    resolve({
                        width: this.naturalWidth || this.width,
                        height: this.naturalHeight || this.height,
                        loadTime: loadTime
                    });
                };
                
                img.onerror = function(error) {
                    clearTimeout(timeout);
                    reject(new Error(`Error de carga en ${apiName}: ${error.message || 'Error desconocido'}`));
                };
                
                // Iniciar carga con manejo de errores
                try {
                    img.src = imageUrl;
                } catch (error) {
                    clearTimeout(timeout);
                    reject(new Error(`Error estableciendo src en ${apiName}: ${error.message}`));
                }
            });
        }
        
        // Crear placeholder art√≠stico mejorado
        function createArtisticPlaceholder(prompt, width, height, seed, lastError) {
            const colors = [
                ['#8b5cf6', '#ec4899'], // P√∫rpura a Rosa
                ['#06b6d4', '#3b82f6'], // Cian a Azul  
                ['#10b981', '#059669'], // Verde
                ['#f59e0b', '#d97706'], // √Åmbar
                ['#ef4444', '#dc2626']  // Rojo
            ];
            
            const colorPair = colors[seed % colors.length];
            const emoji = ['üé≠', 'üé®', '‚ú®', 'üåü', 'üé™'][seed % 5];
            
            const svgContent = `
                <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${colorPair[0]};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${colorPair[1]};stop-opacity:1" />
                        </linearGradient>
                        <pattern id="dots" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                            <circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grad)"/>
                    <rect width="100%" height="100%" fill="url(#dots)"/>
                    <text x="50%" y="40%" text-anchor="middle" fill="white" font-size="64" font-family="Arial">${emoji}</text>
                    <text x="50%" y="55%" text-anchor="middle" fill="white" font-size="24" font-family="Arial, sans-serif" font-weight="bold">Tu Imagen √âpica</text>
                    <text x="50%" y="65%" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-size="16" font-family="Arial, sans-serif">narrativAI - Generador Visual</text>
                    <text x="50%" y="75%" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="12" font-family="Arial, sans-serif">"${prompt.substring(0, 60)}${prompt.length > 60 ? '...' : ''}"</text>
                    <text x="50%" y="85%" text-anchor="middle" fill="rgba(255,255,255,0.5)" font-size="10" font-family="Arial, sans-serif">Seed: ${seed} | ${width}x${height}</text>
                </svg>
            `;
            
            return {
                url: `data:image/svg+xml;base64,${btoa(svgContent)}`,
                prompt: prompt,
                originalPrompt: prompt,
                width: width,
                height: height,
                seed: seed,
                api: 'Placeholder Art√≠stico',
                isPlaceholder: true,
                error: lastError?.message || 'APIs no disponibles'
            };
        }

        // Generar imagen usando m√∫ltiples APIs con manejo de errores robusto
        async function generatePerchanceImage(prompt) {
            const width = 1024;
            const height = 768;
            const seed = Math.floor(Math.random() * 1000000);
            
            // Limpiar prompt para evitar caracteres problem√°ticos
            const cleanPrompt = prompt
                .replace(/[^a-zA-Z0-9\s,.-]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .substring(0, 500);
            
            console.log('üé® Iniciando generaci√≥n de imagen...');
            console.log('üìù Prompt limpio:', cleanPrompt);
            
            // APIs con mejores configuraciones para evitar errores de runtime
            const imageAPIs = [
                {
                    name: 'Pollinations AI',
                    generateUrl: () => {
                        const params = new URLSearchParams({
                            width: width.toString(),
                            height: height.toString(),
                            seed: seed.toString(),
                            nologo: 'true',
                            enhance: 'true',
                            model: 'flux'
                        });
                        return `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?${params.toString()}`;
                    }
                },
                {
                    name: 'Picsum Photos',
                    generateUrl: () => `https://picsum.photos/seed/${seed}/${width}/${height}.jpg?blur=0&grayscale=0`
                },
                {
                    name: 'Lorem Picsum',
                    generateUrl: () => `https://picsum.photos/${width}/${height}?random=${seed}&t=${Date.now()}`
                }
            ];
            
            let lastError = null;
            
            for (let i = 0; i < imageAPIs.length; i++) {
                const api = imageAPIs[i];
                
                try {
                    console.log(`üîÑ Intentando API ${i + 1}/${imageAPIs.length}: ${api.name}`);
                    
                    const imageUrl = api.generateUrl();
                    console.log('üîó URL generada:', imageUrl);
                    
                    // Usar fetch con timeout personalizado para evitar problemas de runtime
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                    }, 15000); // 15 segundos de timeout
                    
                    try {
                        // Verificar primero con fetch
                        const response = await fetch(imageUrl, {
                            method: 'HEAD',
                            signal: controller.signal,
                            mode: 'no-cors' // Evitar problemas de CORS
                        });
                        
                        clearTimeout(timeoutId);
                        
                        // Si fetch funciona, proceder con Image
                        const result = await loadImageSafely(imageUrl, api.name);
                        
                        console.log(`‚úÖ ¬°Imagen cargada exitosamente con ${api.name}!`);
                        
                        return {
                            url: imageUrl,
                            prompt: cleanPrompt,
                            originalPrompt: prompt,
                            width: result.width || width,
                            height: result.height || height,
                            seed: seed,
                            api: api.name,
                            loadTime: result.loadTime
                        };
                        
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        console.warn(`‚ö†Ô∏è Fetch fall√≥ para ${api.name}:`, fetchError.message);
                        
                        // Intentar cargar directamente con Image como fallback
                        try {
                            const result = await loadImageSafely(imageUrl, api.name);
                            console.log(`‚úÖ Imagen cargada con fallback directo - ${api.name}`);
                            
                            return {
                                url: imageUrl,
                                prompt: cleanPrompt,
                                originalPrompt: prompt,
                                width: result.width || width,
                                height: result.height || height,
                                seed: seed,
                                api: `${api.name} (Fallback)`,
                                loadTime: result.loadTime
                            };
                            
                        } catch (imageError) {
                            console.warn(`‚ùå Tambi√©n fall√≥ el fallback para ${api.name}:`, imageError.message);
                            lastError = imageError;
                        }
                    }
                    
                } catch (error) {
                    console.warn(`üí• Error general en ${api.name}:`, error.message);
                    lastError = error;
                }
                
                // Pausa breve entre intentos para evitar rate limiting
                if (i < imageAPIs.length - 1) {
                    console.log('‚è≥ Esperando antes del siguiente intento...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // Si todas las APIs fallan, generar placeholder mejorado
            console.warn('‚ö†Ô∏è Todas las APIs de imagen fallaron, generando placeholder art√≠stico...');
            
            return createArtisticPlaceholder(cleanPrompt, width, height, seed, lastError);
        }

        // Mostrar imagen generada en la galer√≠a con manejo robusto de errores
        function displayImage(imageResult) {
            console.log('üñºÔ∏è Mostrando imagen en galer√≠a:', imageResult);
            
            try {
                const placeholder = document.getElementById('imagePlaceholder');
                const gallery = document.getElementById('imageGallery');
                const controls = document.getElementById('imageControls');
                const status = document.getElementById('imageStatus');
                
                // Validar que tenemos los elementos necesarios
                if (!placeholder || !gallery || !controls || !status) {
                    console.error('‚ùå No se encontraron los elementos de la galer√≠a');
                    showNotification('‚ùå Error en la interfaz de galer√≠a', 'red');
                    return;
                }
                
                // Validar imageResult
                if (!imageResult || !imageResult.url) {
                    console.error('‚ùå Resultado de imagen inv√°lido:', imageResult);
                    showNotification('‚ùå Datos de imagen inv√°lidos', 'red');
                    return;
                }
                
                appState.currentImageUrl = imageResult.url;
                appState.currentImagePrompt = imageResult.prompt || '';
                
                const imageData = {
                    ...imageResult,
                    timestamp: Date.now(),
                    id: `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                appState.imageHistory.push(imageData);
                console.log('üìö Imagen a√±adida al historial. Total:', appState.imageHistory.length);
                
                // Actualizar UI de forma segura
                try {
                    placeholder.classList.add('hidden');
                    gallery.classList.remove('hidden');
                    controls.classList.remove('hidden');
                    
                    renderImageGallery();
                    
                    // Actualizar status con informaci√≥n m√°s detallada
                    const artStyleSelect = document.getElementById('artStyle');
                    const selectedStyle = artStyleSelect ? 
                        artStyleSelect.options[artStyleSelect.selectedIndex].text : 
                        'Autom√°tico';
                    
                    const statusContent = `
                        <div class="text-sm">
                            üé® <strong>Imagen generada:</strong> ${imageResult.width || 1024}x${imageResult.height || 768}
                            <br>üìê <strong>API:</strong> ${imageResult.api || 'Desconocida'}
                            <br>üé≠ <strong>Estilo:</strong> ${selectedStyle}
                            ${imageResult.seed ? `<br>üé≤ <strong>Seed:</strong> ${imageResult.seed}` : ''}
                            ${imageResult.loadTime ? `<br>‚è±Ô∏è <strong>Tiempo:</strong> ${imageResult.loadTime}ms` : ''}
                            ${imageResult.isPlaceholder ? '<br>‚ö†Ô∏è <strong>Modo:</strong> Placeholder' : ''}
                        </div>
                    `;
                    
                    status.innerHTML = statusContent;
                    status.classList.remove('hidden');
                    
                } catch (uiError) {
                    console.error('‚ùå Error actualizando UI:', uiError);
                    showNotification('‚ö†Ô∏è Error en la interfaz, pero imagen guardada', 'yellow');
                }
                
                // Notificaci√≥n de √©xito con manejo de errores
                try {
                    const notificationMessage = imageResult.isPlaceholder ? 
                        '‚ö†Ô∏è Placeholder creado' : 
                        '‚úÖ ¬°Imagen √©pica creada!';
                    
                    const notificationType = imageResult.isPlaceholder ? 'yellow' : 'green';
                    
                    showNotification(`${notificationMessage} - ${imageResult.api}`, notificationType);
                    
                } catch (notificationError) {
                    console.warn('‚ùå Error mostrando notificaci√≥n:', notificationError);
                }
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en displayImage:', error);
                showNotification('‚ùå Error cr√≠tico mostrando imagen', 'red');
            }
        }

        // Renderizar galer√≠a de im√°genes
        function renderImageGallery() {
            const gallery = document.getElementById('imageGallery');
            
            if (appState.imageHistory.length === 0) {
                gallery.innerHTML = '';
                return;
            }
            
            let galleryHTML = `
                <div class="mb-4 p-4 bg-purple-900/20 rounded-lg border border-purple-500/30">
                    <h4 class="text-sm font-medium text-purple-300 mb-2">üé® Tu Galer√≠a √âpica (${appState.imageHistory.length} im√°genes)</h4>
                </div>
            `;
            
            galleryHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            appState.imageHistory.forEach((imageData, index) => {
                galleryHTML += `
                    <div class="image-gallery-item relative group">
                        <img src="${imageData.url}" 
                             alt="Imagen √©pica ${index + 1}" 
                             class="w-full h-48 object-cover rounded-lg border border-gray-600 cursor-pointer"
                             onclick="openImageModal('${imageData.id}')">
                        
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/70 transition-all duration-300 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <div class="text-center text-white">
                                <p class="text-sm font-medium mb-2">Imagen #${index + 1}</p>
                                <div class="flex gap-2">
                                    <button onclick="openImageModal('${imageData.id}')" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                        üëÅÔ∏è Ver
                                    </button>
                                    <button onclick="removeImage('${imageData.id}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                        ‚ùå
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm rounded px-2 py-1">
                            <p class="text-xs text-green-300">#${index + 1}</p>
                        </div>
                    </div>
                `;
            });
            
            galleryHTML += '</div>';
            gallery.innerHTML = galleryHTML;
        }

        // Manejar generaci√≥n principal
        async function handleGeneration() {
            if (appState.isGenerating) return;
            
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnText = document.getElementById('generateBtnText');
            const loadingNarrative = document.getElementById('loadingNarrative');
            const narrativePlaceholder = document.getElementById('narrativePlaceholder');
            const narrativeContent = document.getElementById('narrativeContent');
            
            try {
                appState.isGenerating = true;
                generateBtn.disabled = true;
                generateBtnText.textContent = 'üé≠ Tejiendo √©pica...';
                loadingNarrative.classList.remove('hidden');
                narrativePlaceholder.classList.add('hidden');
                narrativeContent.classList.add('hidden');
                
                const narrative = generateNarrative();
                appState.generatedNarrative = narrative;
                
                // Simular tiempo de procesamiento para mejor UX
                await new Promise(resolve => setTimeout(resolve, 2000));
                loadingNarrative.classList.add('hidden');
                
                const narrativeDisplay = document.getElementById('narrativeDisplay');
                if (narrativeDisplay) {
                    narrativeDisplay.innerHTML = narrative.replace(/\n/g, '<br><br>');
                }
                
                narrativeContent.classList.remove('hidden');
                updateProgress();
                
                // Generar imagen si est√° activada
                if (appState.useImageAI) {
                    const loadingImage = document.getElementById('loadingImage');
                    const imagePlaceholder = document.getElementById('imagePlaceholder');
                    
                    imagePlaceholder.classList.add('hidden');
                    loadingImage.classList.remove('hidden');
                    
                    try {
                        const customElements = [
                            document.getElementById('element1')?.value?.trim() || '',
                            document.getElementById('element2')?.value?.trim() || '',
                            document.getElementById('element3')?.value?.trim() || ''
                        ].filter(Boolean);
                        
                        console.log('üé® Iniciando generaci√≥n de imagen...');
                        const imagePrompt = createImagePrompt(narrative, customElements);
                        console.log('üìù Prompt creado:', imagePrompt);
                        
                        // Agregar delay para evitar problemas de runtime
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const imageResult = await generatePerchanceImage(imagePrompt);
                        console.log('‚úÖ Resultado de imagen:', imageResult);
                        
                        loadingImage.classList.add('hidden');
                        displayImage(imageResult);
                        
                        // Mostrar notificaci√≥n especial si es placeholder
                        if (imageResult.isPlaceholder) {
                            showNotification('‚ö†Ô∏è Modo Placeholder - APIs no disponibles', 'yellow');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error cr√≠tico generando imagen:', error);
                        loadingImage.classList.add('hidden');
                        imagePlaceholder.classList.remove('hidden');
                        
                        // Crear placeholder de emergencia
                        try {
                            const emergencyPlaceholder = createArtisticPlaceholder(
                                imagePrompt || 'imagen √©pica', 
                                1024, 768, 
                                Math.floor(Math.random() * 1000000),
                                error
                            );
                            displayImage(emergencyPlaceholder);
                        } catch (placeholderError) {
                            console.error('‚ùå Error creando placeholder de emergencia:', placeholderError);
                        }
                        
                        showNotification('‚ùå Error cr√≠tico - Sistema de placeholder activado', 'red');
                    }
                }
                
            } catch (error) {
                console.error('Error en la generaci√≥n:', error);
                
                showNotification(error.message, 'red');
                
                loadingNarrative.classList.add('hidden');
                narrativePlaceholder.classList.remove('hidden');
            } finally {
                appState.isGenerating = false;
                generateBtn.disabled = false;
                generateBtnText.textContent = 'üé≠ Generar Narrativa';
            }
        }

        // Funciones globales para controles
        window.setDetailLevel = function(level) {
            appState.detailLevel = level;
            
            // Actualizar botones visuales
            document.querySelectorAll('.detail-btn').forEach(btn => {
                btn.className = 'detail-btn px-3 py-2 bg-gray-700 hover:bg-purple-600 rounded-lg text-xs transition-colors';
            });
            event.target.className = 'detail-btn active px-3 py-2 bg-purple-600 rounded-lg text-xs';
        };

        window.regenerateImage = async function() {
            if (!appState.generatedNarrative) {
                showNotification('‚ö†Ô∏è Genera una narrativa primero.', 'yellow');
                return;
            }
            
            const loadingImage = document.getElementById('loadingImage');
            const gallery = document.getElementById('imageGallery');
            
            // Mostrar loading y ocultar galer√≠a temporalmente
            if (loadingImage) loadingImage.classList.remove('hidden');
            if (gallery) gallery.classList.add('hidden');
            
            try {
                console.log('üîÑ Regenerando imagen...');
                
                // Delay para evitar problemas de runtime
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const customElements = [
                    document.getElementById('element1')?.value?.trim() || '',
                    document.getElementById('element2')?.value?.trim() || '',
                    document.getElementById('element3')?.value?.trim() || ''
                ].filter(Boolean);
                
                const imagePrompt = createImagePrompt(appState.generatedNarrative, customElements);
                const imageResult = await generatePerchanceImage(imagePrompt);
                
                if (loadingImage) loadingImage.classList.add('hidden');
                displayImage(imageResult);
                
                // Notificaci√≥n de regeneraci√≥n exitosa
                if (imageResult.isPlaceholder) {
                    showNotification('‚ö†Ô∏è Regenerado en modo placeholder', 'yellow');
                } else {
                    showNotification('‚úÖ ¬°Nueva variaci√≥n creada!', 'green');
                }
                
            } catch (error) {
                console.error('‚ùå Error regenerando imagen:', error);
                if (loadingImage) loadingImage.classList.add('hidden');
                if (gallery) gallery.classList.remove('hidden');
                
                // Intentar crear placeholder de emergencia
                try {
                    const emergencyPlaceholder = createArtisticPlaceholder(
                        'imagen √©pica regenerada', 
                        1024, 768, 
                        Math.floor(Math.random() * 1000000),
                        error
                    );
                    displayImage(emergencyPlaceholder);
                    showNotification('‚ö†Ô∏è Placeholder generado tras error', 'yellow');
                } catch (placeholderError) {
                    showNotification(`‚ùå Error: ${error.message || 'Error cr√≠tico'}`, 'red');
                }
            }
        };

        window.clearImageHistory = function() {
            if (confirm('¬øSeguro que quieres limpiar toda la galer√≠a de im√°genes?')) {
                appState.imageHistory = [];
                
                const gallery = document.getElementById('imageGallery');
                const placeholder = document.getElementById('imagePlaceholder');
                const controls = document.getElementById('imageControls');
                const status = document.getElementById('imageStatus');
                
                gallery.classList.add('hidden');
                placeholder.classList.remove('hidden');
                controls.classList.add('hidden');
                status.classList.add('hidden');
            }
        };

        window.openImageModal = function(imageId) {
            const imageData = appState.imageHistory.find(img => img.id === imageId);
            if (!imageData) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.onclick = () => document.body.removeChild(modal);
            
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full bg-gray-800 rounded-lg overflow-hidden" onclick="event.stopPropagation()">
                    <div class="p-4 border-b border-gray-600">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-purple-400">üé® Tu Imagen √âpica</h3>
                            <button onclick="document.body.removeChild(document.querySelector('.fixed'))" class="text-gray-400 hover:text-white text-xl">√ó</button>
                        </div>
                    </div>
                    <div class="p-4">
                        <img src="${imageData.url}" alt="Imagen √©pica" class="w-full rounded-lg mb-4">
                        <div class="text-sm text-gray-300">
                            <p><strong>Generado:</strong> ${new Date(imageData.timestamp).toLocaleString('es-ES')}</p>
                            <p><strong>Dimensiones:</strong> ${imageData.width}x${imageData.height}</p>
                            <p class="mt-2"><strong>Prompt:</strong></p>
                            <p class="text-xs font-mono bg-gray-900/50 p-3 rounded mt-1">${imageData.prompt}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        window.removeImage = function(imageId) {
            if (confirm('¬øEliminar esta imagen de la galer√≠a?')) {
                appState.imageHistory = appState.imageHistory.filter(img => img.id !== imageId);
                
                if (appState.imageHistory.length === 0) {
                    clearImageHistory();
                } else {
                    renderImageGallery();
                }
            }
        };

        window.toggleHelp = function() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('hidden');
        };

        // Funci√≥n principal para descargar proyecto completo
        window.downloadCompleteProject = async function() {
            if (!appState.generatedNarrative) {
                showNotification('‚ö†Ô∏è Genera una narrativa primero.', 'yellow');
                return;
            }
            
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'üì¶ Creando ZIP...';
            downloadBtn.disabled = true;
            
            try {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                
                // Generar contenido markdown
                let markdownContent = '# üé≠ Tu Narrativa √âpica - narrativAI\n\n';
                markdownContent += '**Proyecto generado el:** ' + new Date().toLocaleString('es-ES') + '\n\n';
                markdownContent += '## üìñ Tu Historia √âpica\n\n';
                markdownContent += appState.generatedNarrative + '\n\n';
                markdownContent += '## ‚öñÔ∏è Configuraci√≥n de G√©neros\n\n';
                markdownContent += '**G√©neros seleccionados:** ' + appState.selectedGenres.map(id => genres[id].icon + ' ' + genres[id].name + ' (' + (appState.genreIntensities[id] || 70) + '%)').join(', ') + '\n\n';
                
                const element1 = document.getElementById('element1').value || 'No especificado';
                const element2 = document.getElementById('element2').value || 'No especificado';
                const element3 = document.getElementById('element3').value || 'No especificado';
                
                markdownContent += '## üéØ Elementos Personalizados\n\n';
                markdownContent += '- **üéØ Principal:** ' + element1 + '\n';
                markdownContent += '- **üî∏ Secundario:** ' + element2 + '\n';
                markdownContent += '- **üèõÔ∏è Contexto:** ' + element3 + '\n\n';
                
                if (appState.imageHistory.length > 0) {
                    markdownContent += '## üé® Configuraci√≥n de Imagen IA\n\n';
                    markdownContent += '**Total de im√°genes generadas:** ' + appState.imageHistory.length + '\n\n';
                }
                
                markdownContent += '\n\n---\n\n*Generado con ‚ù§Ô∏è por **narrativAI*** üé≠‚ú®';
                
                zip.file('narrativa.md', markdownContent);
                
                // A√±adir im√°genes si existen
                if (appState.imageHistory.length > 0) {
                    for (let i = 0; i < appState.imageHistory.length; i++) {
                        try {
                            const response = await fetch(appState.imageHistory[i].url);
                            const blob = await response.blob();
                            zip.file(`imagen-${String(i + 1).padStart(2, '0')}.jpg`, blob);
                        } catch (error) {
                            console.warn('Error a√±adiendo imagen:', error);
                        }
                    }
                }
                
                // README
                let readmeContent = 'üì¶ PROYECTO NARRATIVAI - TU √âPICA COMPLETA\n';
                readmeContent += '==========================================\n\n';
                readmeContent += 'üé≠ ¬°Tu leyenda est√° lista!\n\n';
                readmeContent += 'Contenido del proyecto:\n';
                readmeContent += '- narrativa.md: Tu historia √©pica completa\n';
                readmeContent += appState.imageHistory.length > 0 ? `- ${appState.imageHistory.length} im√°genes √©picas generadas\n` : '';
                readmeContent += '- README.txt: Este archivo\n\n';
                readmeContent += '‚ú® Generado con narrativAI\n';
                readmeContent += 'Fecha: ' + new Date().toLocaleString('es-ES') + '\n';
                
                zip.file('README.txt', readmeContent);
                
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `narrativAI-epica-${timestamp}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('üéâ ¬°Proyecto descargado exitosamente!', 'green');
                
            } catch (error) {
                console.error('Error creando proyecto ZIP:', error);
                showNotification('‚ö†Ô∏è Error creando el archivo ZIP.', 'red');
            } finally {
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        };

        // Funciones de edici√≥n de narrativa
        window.toggleNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            
            if (!isEditingNarrative) {
                isEditingNarrative = true;
                originalNarrativeText = appState.generatedNarrative;
                
                narrativeDisplay.classList.add('hidden');
                narrativeEditor.classList.remove('hidden');
                narrativeEditor.value = appState.generatedNarrative;
                narrativeEditor.focus();
                
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
            }
        };

        window.saveNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            
            if (isEditingNarrative) {
                const newText = narrativeEditor.value.trim();
                
                if (newText === '') {
                    showNotification('‚ö†Ô∏è La narrativa no puede estar vac√≠a.', 'yellow');
                    return;
                }
                
                appState.generatedNarrative = newText;
                narrativeDisplay.innerHTML = newText.replace(/\n/g, '<br><br>');
                
                narrativeDisplay.classList.remove('hidden');
                narrativeEditor.classList.add('hidden');
                
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                isEditingNarrative = false;
                
                showNotification('‚úÖ Narrativa actualizada exitosamente.', 'green');
            }
        };

        window.cancelNarrativeEdit = function() {
            const narrativeDisplay = document.getElementById('narrativeDisplay');
            const narrativeEditor = document.getElementById('narrativeEditor');
            const editBtn = document.getElementById('editNarrativeBtn');
            const saveBtn = document.getElementById('saveNarrativeBtn');
            const cancelBtn = document.getElementById('cancelNarrativeBtn');
            
            if (isEditingNarrative) {
                narrativeEditor.value = originalNarrativeText;
                
                narrativeDisplay.classList.remove('hidden');
                narrativeEditor.classList.add('hidden');
                
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                isEditingNarrative = false;
            }
        };

        // Configurar event listeners
        function setupEventListeners() {
            const useImageAICheckbox = document.getElementById('useImageAI');
            if (useImageAICheckbox) {
                useImageAICheckbox.addEventListener('change', (e) => {
                    appState.useImageAI = e.target.checked;
                    const info = document.getElementById('imageAIInfo');
                    const artStyleSection = document.getElementById('artStyleSection');
                    const detailSection = document.getElementById('detailSection');
                    const placeholderMessage = document.getElementById('placeholderMessage');
                    const readyMessage = document.getElementById('readyMessage');
                    
                    if (appState.useImageAI) {
                        if (info) info.classList.remove('hidden');
                        if (artStyleSection) artStyleSection.classList.remove('hidden');
                        if (detailSection) detailSection.classList.remove('hidden');
                        if (placeholderMessage) placeholderMessage.classList.add('hidden');
                        if (readyMessage) readyMessage.classList.remove('hidden');
                    } else {
                        if (info) info.classList.add('hidden');
                        if (artStyleSection) artStyleSection.classList.add('hidden');
                        if (detailSection) detailSection.classList.add('hidden');
                        if (placeholderMessage) placeholderMessage.classList.remove('hidden');
                        if (readyMessage) readyMessage.classList.add('hidden');
                    }
                });
            }

            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGeneration);
            }

            // Atajos de teclado para narrativa
            const narrativeEditor = document.getElementById('narrativeEditor');
            if (narrativeEditor) {
                narrativeEditor.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        saveNarrativeEdit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelNarrativeEdit();
                    }
                });
            }
        }

        // Inicializaci√≥n con manejo robusto de errores
        function initializeApp() {
            try {
                console.log('üöÄ Iniciando narrativAI...');
                
                // Verificar elementos cr√≠ticos del DOM
                const criticalElements = [
                    'genreGrid', 'generateBtn', 'step1-container', 
                    'imageGallery', 'narrativeContent'
                ];
                
                const missingElements = criticalElements.filter(id => 
                    !document.getElementById(id)
                );
                
                if (missingElements.length > 0) {
                    console.warn('‚ö†Ô∏è Elementos faltantes:', missingElements);
                }
                
                // Inicializar componentes de forma segura
                try {
                    createGenreElements();
                    console.log('‚úÖ G√©neros creados');
                } catch (error) {
                    console.error('‚ùå Error creando g√©neros:', error);
                }
                
                try {
                    updateGenreCount();
                    console.log('‚úÖ Contador de g√©neros actualizado');
                } catch (error) {
                    console.error('‚ùå Error actualizando contador:', error);
                }
                
                try {
                    setupEventListeners();
                    console.log('‚úÖ Event listeners configurados');
                } catch (error) {
                    console.error('‚ùå Error configurando listeners:', error);
                }
                
                try {
                    updateProgress();
                    console.log('‚úÖ Progreso actualizado');
                } catch (error) {
                    console.error('‚ùå Error actualizando progreso:', error);
                }
                
                // Verificar funcionalidades cr√≠ticas
                console.log('üîç Verificando funcionalidades...');
                console.log('- Estado de app:', appState);
                console.log('- G√©neros disponibles:', Object.keys(genres).length);
                console.log('- IA de im√°genes:', appState.useImageAI ? 'Activada' : 'Desactivada');
                
                console.log('üé≠ narrativAI inicializado correctamente - ¬°Listo para crear √©picas!');
                
                // Notificaci√≥n de bienvenida
                setTimeout(() => {
                    showNotification('üé≠ ¬°narrativAI listo! Comienza creando tu √©pica', 'purple');
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                
                // Notificaci√≥n de error cr√≠tico
                setTimeout(() => {
                    showNotification('‚ùå Error de inicializaci√≥n - Recarga la p√°gina', 'red');
                }, 1000);
            }
        }

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
